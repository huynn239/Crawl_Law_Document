ÄÃ£ fix cáº£ 2 file. Cháº¡y láº¡i:

```bash
python -m tvpl_crawler.cleanup_sessions
```

---

Batch 1/198 - 15 vÄƒn báº£n

============================================================

ğŸ” Login má»›i vá»›i UA: ...) Gecko/20100101 Firefox/119.0


[1/2958] Quyáº¿t Ä‘á»‹nh 014/2025/QÄ-UBND quy Ä‘á»‹nh chá»©c nÄƒng, nhiá»‡m vá»¥ vÃ  ...

  URL: https://thuvienphapluat.vn/van-ban/Thuong-mai/Quyet-dinh-014-2025-QD-UBND-chuc-nang-nhiem-vu-Chi-Cuc-Quan-ly-thi-truong-Dak-Lak-674723.aspx

  â± Delay 3.1s...


[2/2958] Quyáº¿t Ä‘á»‹nh 1479/QÄ-UBND nÄƒm 2025 vá» Quy cháº¿ báº£o Ä‘áº£m an ninh ...

  URL: https://thuvienphapluat.vn/van-ban/Cong-nghe-thong-tin/Quyet-dinh-1479-QD-UBND-2025-quy-che-bao-dam-an-ninh-manh-he-thong-thong-tin-Hung-Yen-678009.aspx

  â± Delay 2.3s...

  âš  [2] Data null, retry...

  âš  [1] Data null, retry...

  âš  [2] Data null sau retry, skip


[3/2958] Quyáº¿t Ä‘á»‹nh 2322/QÄ-UBND nÄƒm 2025 bÃ£i bá» Quyáº¿t Ä‘á»‹nh cá»§a á»¦y ba...

  URL: https://thuvienphapluat.vn/van-ban/Bo-may-hanh-chinh/Quyet-dinh-2322-QD-UBND-2025-bai-bo-quyet-dinh-cua-Uy-ban-tinh-Binh-Dinh-Gia-Lai-678329.aspx

  â± Delay 3.4s...

  âš  [1] Data null sau retry, skip


[4/2958] CÃ´ng Ä‘iá»‡n 201/CÄ-TTg nÄƒm 2025 táº­p trung rÃ  soÃ¡t, cáº¯t giáº£m, Ä‘...

---

Váº¥n Ä‘á» "Data null" váº«n xáº£y ra nhiá»u. CÃ³ thá»ƒ do:

1. **Timeout 30s khÃ´ng Ä‘á»§** cho trang load cháº­m
2. **CAPTCHA trÃªn trang chi tiáº¿t** (khÃ´ng chá»‰ search page)
3. **Tab4 load cháº­m** (JavaScript async)

Kiá»ƒm tra xem `playwright_extract_async.py` cÃ³ xá»­ lÃ½ CAPTCHA trÃªn trang chi tiáº¿t khÃ´ng:

---

CÃ³ bypass CAPTCHA á»Ÿ dÃ²ng 23-25, nhÆ°ng cÃ³ thá»ƒ cáº§n tÄƒng timeout. ThÃªm log Ä‘á»ƒ debug:

---

ÄÃ£ tÄƒng timeout cho tab4 tá»« 5sâ†’8s vÃ  wait time tá»« 2sâ†’3s. Náº¿u váº«n bá»‹ null nhiá»u, cháº¡y vá»›i timeout lá»›n hÆ¡n:

```bash
python -m tvpl_crawler.crawl_data_fast data/links.json data/result.json 2 60000 --save-per-batch
```

(60s thay vÃ¬ 30s)

---

stream = self._network_backend.connect_tcp(**kwargs)

             â”‚    â”‚                â”‚             â”” {&#39;host&#39;: &#39;kbzprrfclidmligwzzom.supabase.co&#39;, &#39;port&#39;: 443, &#39;local_address&#39;: None, &#39;timeout&#39;: 120, &#39;socket_options&#39;: None}

             â”‚    â”‚                â”” &lt;function SyncBackend.connect_tcp at 0x724c5086dcf0&gt;

             â”‚    â”” &lt;httpcore.SyncBackend object at 0x724c507f10c0&gt;

             â”” &lt;HTTPConnection [CONNECTION FAILED]&gt;

  File &quot;/usr/local/lib/python3.10/dist-packages/httpcore/_backends/sync.py&quot;, line 207, in connect_tcp

    with map_exceptions(exc_map):

         â”‚              â”” {&lt;class &#39;TimeoutError&#39;&gt;: &lt;class &#39;httpcore.ConnectTimeout&#39;&gt;, &lt;class &#39;OSError&#39;&gt;: &lt;class &#39;httpcore.ConnectError&#39;&gt;}

         â”” &lt;function map_exceptions at 0x724c5086c940&gt;

  File &quot;/usr/lib/python3.10/contextlib.py&quot;, line 153, in __exit__

    self.gen.throw(typ, value, traceback)

    â”‚    â”‚   â”‚     â”‚    â”‚      â”” &lt;traceback object at 0x724c5080c2c0&gt;

    â”‚    â”‚   â”‚     â”‚    â”” gaierror(-5, &#39;No address associated with hostname&#39;)

    â”‚    â”‚   â”‚     â”” &lt;class &#39;socket.gaierror&#39;&gt;

    â”‚    â”‚   â”” &lt;method &#39;throw&#39; of &#39;generator&#39; objects&gt;

    â”‚    â”” &lt;generator object map_exceptions at 0x724c50793450&gt;

    â”” &lt;contextlib._GeneratorContextManager object at 0x724c507f1870&gt;

  File &quot;/usr/local/lib/python3.10/dist-packages/httpcore/_exceptions.py&quot;, line 14, in map_exceptions

    raise to_exc(exc) from exc

          â”” &lt;class &#39;httpcore.ConnectError&#39;&gt;


httpcore.ConnectError: [Errno -5] No address associated with hostname

---

Lá»—i DNS khÃ´ng resolve Ä‘Æ°á»£c `kbzprrfclidmligwzzom.supabase.co`. CÃ³ thá»ƒ do:

1. **KhÃ´ng cÃ³ internet** hoáº·c DNS bá»‹ cháº·n
2. **Supabase URL sai** trong `.env`
3. **Firewall/VPN** cháº·n káº¿t ná»‘i

ThÃªm fallback Ä‘á»ƒ skip lÆ°u DB náº¿u khÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c:

---

BÃ¢y giá» náº¿u khÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c Supabase â†’ tá»± Ä‘á»™ng táº¯t `SAVE_PER_BATCH` vÃ  chá»‰ lÆ°u JSON. Kiá»ƒm tra láº¡i káº¿t ná»‘i:

```bash
ping kbzprrfclidmligwzzom.supabase.co
```

Hoáº·c test trong Python:
```python
python -c "from supabase import create_client; import os; from dotenv import load_dotenv; load_dotenv(); print(create_client(os.getenv('SUPABASE_URL'), os.getenv('SUPABASE_KEY')).table('doc_urls').select('count').limit(1).execute())"
```

---

tÃ´i Ä‘ang má»Ÿ vpn windscribe

---

VPN Windscribe cÃ³ thá»ƒ cháº·n DNS hoáº·c káº¿t ná»‘i Supabase. Thá»­:

1. **Táº¯t VPN** khi crawl (náº¿u khÃ´ng cáº§n VPN Ä‘á»ƒ truy cáº­p thuvienphapluat.vn)
2. **Hoáº·c whitelist Supabase** trong VPN settings
3. **Hoáº·c cháº¡y khÃ´ng lÆ°u DB** (bá» flag `--save-per-batch`):

```bash
python -m tvpl_crawler.crawl_data_fast data/links.json data/result.json 2 30000
```

Sau Ä‘Ã³ import JSON vÃ o DB khi táº¯t VPN:

```bash
python -m tvpl_crawler.import_supabase_v2 data/result.json
```

Hoáº·c kiá»ƒm tra xem VPN cÃ³ split tunneling khÃ´ng Ä‘á»ƒ exclude Supabase domain.

---

sao tÃ´i dÃ¹ng hideme thÃ¬ Ä‘Æ°á»£c windscribe thÃ¬ k

---

Windscribe cÃ³ thá»ƒ:

1. **Cháº·n DNS leak** â†’ khÃ´ng resolve Ä‘Æ°á»£c domain Supabase
2. **Firewall rules** khÃ¡c vá»›i hide.me
3. **Server location** khÃ¡c â†’ má»™t sá»‘ region cháº·n AWS/Supabase

**Giáº£i phÃ¡p nhanh:**

ThÃªm Supabase vÃ o **Split Tunneling** trong Windscribe:
- Settings â†’ Split Tunneling â†’ Add `*.supabase.co`

Hoáº·c dÃ¹ng **hide.me khi crawl** náº¿u cáº§n VPN + DB cÃ¹ng lÃºc.

Hoáº·c code Ä‘Ã£ cÃ³ fallback â†’ cháº¡y vá»›i Windscribe sáº½ tá»± Ä‘á»™ng skip DB vÃ  chá»‰ lÆ°u JSON:

```bash
python -m tvpl_crawler.crawl_data_fast data/links.json data/result.json 2 30000 --save-per-batch
```

â†’ Sáº½ bÃ¡o "Could not connect to Supabase" vÃ  lÆ°u JSON thÃ´i.

---

giá» tÃ´i muá»‘n dÃ¹ng windscribe thÃ¬ sao , pháº§n split tunneling k tháº¥y cÃ³ supabase

---

ThÃªm IP cá»§a Supabase vÃ o Split Tunneling:

1. **Láº¥y IP cá»§a Supabase:**
```bash
nslookup kbzprrfclidmligwzzom.supabase.co
```

2. **ThÃªm IP vÃ o Windscribe Split Tunneling:**
   - Settings â†’ Connection â†’ Split Tunneling
   - Add IP address tá»« bÆ°á»›c 1

**Hoáº·c Ä‘Æ¡n giáº£n hÆ¡n:** Táº¯t Windscribe khi lÆ°u DB, báº­t láº¡i khi crawl:

```bash
# Crawl vá»›i VPN (khÃ´ng lÆ°u DB)
python -m tvpl_crawler.crawl_data_fast data/links.json data/result.json 2 30000

# Táº¯t VPN, import DB
python -m tvpl_crawler.import_supabase_v2 data/result.json
```

**Hoáº·c dÃ¹ng hide.me** khi cáº§n cáº£ VPN + DB cÃ¹ng lÃºc.

---

SyntaxError: name &#39;SAVE_PER_BATCH&#39; is used prior to global declaration

2025-10-28 07:35:34.895 | ERROR    | api.main:crawl_pending:302 - crawl_data_fast failed with code 1

Fetched 2958 pending URLs

Saved to /tmp/api_pending_links.json

2025-10-28 07:42:36.448 | INFO     | api.main:crawl_pending:293 - Crawling 2958 pending documents: python -m tvpl_crawler.crawl_data_fast /tmp/api_pending_links.json /tmp/api_pending_result.json 2 60000 --save-per-batch

Traceback (most recent call last):

  File &quot;/usr/lib/python3.10/runpy.py&quot;, line 187, in _run_module_as_main

    mod_name, mod_spec, code = _get_module_details(mod_name, _Error)

  File &quot;/usr/lib/python3.10/runpy.py&quot;, line 157, in _get_module_details

    code = loader.get_code(mod_name)

  File &quot;&lt;frozen importlib._bootstrap_external&gt;&quot;, line 1017, in get_code

  File &quot;&lt;frozen importlib._bootstrap_external&gt;&quot;, line 947, in source_to_code

  File &quot;&lt;frozen importlib._bootstrap&gt;&quot;, line 241, in _call_with_frames_removed

  File &quot;/app/tvpl_crawler/crawl_data_fast.py&quot;, line 305

    global SAVE_PER_BATCH

    ^^^^^^^^^^^^^^^^^^^^^

---

Lá»—i `global` declaration pháº£i Ä‘áº·t trÆ°á»›c khi dÃ¹ng biáº¿n. Fix:

---

ÄÃ£ fix. `global` declaration pháº£i Ä‘áº·t á»Ÿ Ä‘áº§u function trÆ°á»›c khi dÃ¹ng biáº¿n.

---

ğŸ” Login má»›i vá»›i UA: ...) Gecko/20100101 Firefox/119.0


[1/2958] Quyáº¿t Ä‘á»‹nh 014/2025/QÄ-UBND quy Ä‘á»‹nh chá»©c nÄƒng, nhiá»‡m vá»¥ vÃ  ...

  URL: https://thuvienphapluat.vn/van-ban/Thuong-mai/Quyet-dinh-014-2025-QD-UBND-chuc-nang-nhiem-vu-Chi-Cuc-Quan-ly-thi-truong-Dak-Lak-674723.aspx

  â± Delay 2.9s...


[2/2958] Quyáº¿t Ä‘á»‹nh 1479/QÄ-UBND nÄƒm 2025 vá» Quy cháº¿ báº£o Ä‘áº£m an ninh ...

  URL: https://thuvienphapluat.vn/van-ban/Cong-nghe-thong-tin/Quyet-dinh-1479-QD-UBND-2025-quy-che-bao-dam-an-ninh-manh-he-thong-thong-tin-Hung-Yen-678009.aspx

  â± Delay 2.3s...

  âš  [2] Data null, retry...

  âš  [1] Data null, retry...

  âš  [2] Data null sau retry, skip


[3/2958] Quyáº¿t Ä‘á»‹nh 2322/QÄ-UBND nÄƒm 2025 bÃ£i bá» Quyáº¿t Ä‘á»‹nh cá»§a á»¦y ba...

  URL: https://thuvienphapluat.vn/van-ban/Bo-may-hanh-chinh/Quyet-dinh-2322-QD-UBND-2025-bai-bo-quyet-dinh-cua-Uy-ban-tinh-Binh-Dinh-Gia-Lai-678329.aspx

  â± Delay 3.4s...

  âš  [1] Data null sau retry, skip
tÃ´i cáº§n tÄƒng kháº£ nÄƒng retry Ä‘á»ƒ láº¥y Ä‘Æ°á»£c data

---

TÄƒng sá»‘ láº§n retry tá»« 2 lÃªn 3 vÃ  tÄƒng timeout má»—i láº§n:

---

Increase retry attempts from 2 to 3 with progressive timeout multiplier

---

ÄÃ£ tÄƒng:
- Retry tá»« 2â†’3 láº§n
- Timeout: 1x â†’ 2x â†’ 3x (thay vÃ¬ 1x â†’ 2x)
- Delay giá»¯a retry: 2s â†’ 3s

---

sao tÃ´i dÃ¹ng api crawl-pending mÃ  khi huá»· process thÃ¬ session váº«n lÆ°u lÃ  running, vÃ  khÃ´ng cÃ³ thÃ´ng tin gi

---

API gá»i subprocess nÃªn khÃ´ng catch Ä‘Æ°á»£c KeyboardInterrupt. ThÃªm timeout vÃ  cleanup:

---

ÄÃ£ thÃªm:
1. **Popen + kill** khi timeout/error
2. **Finally block** cleanup session RUNNING cÅ© hÆ¡n 30s

Hoáº·c cháº¡y cleanup manual:
```bash
python -m tvpl_crawler.cleanup_sessions
```

---

giá» khi tÃ´i cháº¡y mÃ  huy tiáº¿n trÃ¬nh thÃ¬ status hoáº·c thÃ´ng sá»‘ sáº½ cÃ³ Ä‘Ãºng k

---

KhÃ´ng, vÃ¬ subprocess bá»‹ kill trÆ°á»›c khi cáº­p nháº­t. Cáº§n lÆ°u session_id vÃ o file Ä‘á»ƒ API cleanup:

---

BÃ¢y giá» khi há»§y API:
1. **Process bá»‹ kill** â†’ session váº«n RUNNING
2. **Finally block** cháº¡y â†’ tÃ¬m session RUNNING cÅ© hÆ¡n 10s â†’ Ä‘Ã¡nh dáº¥u FAILED vá»›i thÃ´ng sá»‘ hiá»‡n táº¡i (total_docs, new_versions, unchanged_docs)

ThÃ´ng sá»‘ sáº½ Ä‘Ãºng vá»›i sá»‘ vÄƒn báº£n Ä‘Ã£ crawl Ä‘Æ°á»£c trÆ°á»›c khi há»§y.

---

Finally block cháº¡y â†’ tÃ¬m session RUNNING cÅ© hÆ¡n 10s â†’ Ä‘Ã¡nh dáº¥u FAILED vá»›i thÃ´ng sá»‘ hiá»‡n táº¡i (total_docs, new_versions, unchanged_docs) lÃ  sao

---

Logic hiá»‡n táº¡i sai - nÃ³ tÃ¬m session cÅ© hÆ¡n 10s (khÃ´ng pháº£i session vá»«a bá»‹ há»§y). Fix Ä‘á»ƒ láº¥y Ä‘Ãºng session hiá»‡n táº¡i:

---

BÃ¢y giá»:
1. API táº¡o session â†’ lÆ°u session_id vÃ o file temp
2. Subprocess cháº¡y â†’ cáº­p nháº­t total_docs, new_versions má»—i batch
3. Náº¿u bá»‹ há»§y â†’ finally block Ä‘á»c session_id tá»« file â†’ Ä‘Ã¡nh dáº¥u FAILED vá»›i thÃ´ng sá»‘ Ä‘Ã£ lÆ°u trong DB
4. ThÃ´ng sá»‘ (total_docs, new_versions) giá»¯ nguyÃªn giÃ¡ trá»‹ Ä‘Ã£ crawl Ä‘Æ°á»£c

---

Ä‘ang nÃ³i Ä‘áº¿n doc_url Ä‘Ãºng k , vÃ  status Ä‘Ã¡nh lÃ  fail Ã 

---

KhÃ´ng, Ä‘ang nÃ³i vá» báº£ng `crawl_sessions` (tracking tiáº¿n trÃ¬nh crawl), khÃ´ng pháº£i `doc_urls`.

**Vá» `doc_urls`:**
- VÄƒn báº£n crawl thÃ nh cÃ´ng â†’ `status='completed'`
- VÄƒn báº£n lá»—i/chÆ°a crawl â†’ `status='pending'` (khÃ´ng Ä‘á»•i)
- Khi há»§y tiáº¿n trÃ¬nh â†’ cÃ¡c vÄƒn báº£n chÆ°a crawl váº«n lÃ  `pending`, sáº½ crawl láº¡i láº§n sau

**Vá» `crawl_sessions`:**
- Äang crawl â†’ `status='RUNNING'`
- Crawl xong â†’ `status='COMPLETED'`
- Bá»‹ há»§y/lá»—i â†’ `status='FAILED'`

Váº­y lÃ  Ä‘Ãºng rá»“i. VÄƒn báº£n nÃ o chÆ°a ká»‹p crawl váº«n `pending`, crawl láº¡i Ä‘Æ°á»£c.

---

Ä‘á»ƒ time retry lÃªn cao hÆ¡n Ä‘i, nhiá»u khi load trang lÃ¢u

---

ÄÃ£ tÄƒng delay retry tá»« 3s â†’ 5s cho cáº£ 2 hÃ m crawl.

---

táº¡i khi mÃ  bá»‹ cháº·n ip tÃ´i pháº£i thay Ä‘á»•i báº±ng tay thÃ¬ nÃªn cho retry cao hÆ¡n Ä‘á»ƒ tÃ´i cÃ³ thá»ƒ check log ká»‹p vÃ  Ä‘á»•i ip Ä‘Æ°á»£c , cháº¯c cho lÃªn táº§m má»—i retry táº§m 20-25s

---

ÄÃ£ tÄƒng retry delay lÃªn 20-25s. BÃ¢y giá» khi gáº·p lá»—i sáº½ cÃ³ 20-25s Ä‘á»ƒ check log vÃ  Ä‘á»•i IP trÆ°á»›c khi retry.

---

sao khi tÃ´i huá»· process mÃ  status váº«n lÃ  running

---

VÃ¬ subprocess táº¡o session riÃªng, API khÃ´ng biáº¿t session_id cá»§a nÃ³. Fix báº±ng cÃ¡ch truyá»n session_id qua file:

---

BÃ¢y giá» API sáº½:
1. Äá»c stdout cá»§a subprocess Ä‘á»ƒ báº¯t session_id
2. LÆ°u session_id vÃ o file
3. Khi há»§y â†’ finally block kill process vÃ  mark session FAILED

---

sao sau khi sá»­a thÃ¬ toÃ n data null , retry váº«n k láº¥y Ä‘Æ°á»£c data váº­y

---

CÃ³ thá»ƒ do timeout quÃ¡ ngáº¯n hoáº·c trang load cháº­m. Kiá»ƒm tra log xem cÃ³ lá»—i gÃ¬ khÃ´ng:

---

ÄÃ£ thÃªm log Ä‘á»ƒ xem doc_info cÃ³ keys gÃ¬ khi null. Cháº¡y láº¡i Ä‘á»ƒ xem log output.

---

tÃ´i Ä‘ang dÃ¹ng crawl-pending

---

API `/crawl-pending` Ä‘ang dÃ¹ng `subprocess.PIPE` nÃªn khÃ´ng tháº¥y log realtime. Fix Ä‘á»ƒ tháº¥y log:

---

BÃ¢y giá» log sáº½ hiá»‡n trá»±c tiáº¿p. NhÆ°ng session tracking khÃ´ng hoáº¡t Ä‘á»™ng ná»¯a. Náº¿u cáº§n track session khi há»§y, cháº¡y cleanup manual:

```bash
python -m tvpl_crawler.cleanup_sessions
```

Hoáº·c cháº¡y trá»±c tiáº¿p thay vÃ¬ qua API Ä‘á»ƒ tháº¥y log Ä‘áº§y Ä‘á»§:

```bash
python -m tvpl_crawler.crawl_data_fast /tmp/api_pending_links.json /tmp/result.json 2 60000 --save-per-batch
```

---

tÃ´i Ä‘ang cháº¡y api á»Ÿ http://localhost:8000/docs

---

Khi cháº¡y qua API thÃ¬ log khÃ´ng hiá»‡n trÃªn browser. Äá»ƒ xem log:

1. **Xem terminal cháº¡y API** (uvicorn) - log sáº½ hiá»‡n á»Ÿ Ä‘Ã³
2. **Hoáº·c check file log** náº¿u cÃ³ cáº¥u hÃ¬nh
3. **Hoáº·c thÃªm endpoint Ä‘á»ƒ xem log realtime**

Náº¿u muá»‘n debug, tá»‘t nháº¥t lÃ  cháº¡y trá»±c tiáº¿p:

```bash
# Fetch pending URLs
python -m tvpl_crawler.fetch_pending_urls 100 data/pending.json

# Crawl vá»›i log Ä‘áº§y Ä‘á»§
python -m tvpl_crawler.crawl_data_fast data/pending.json data/result.json 2 60000 --save-per-batch
```

Hoáº·c check terminal Ä‘ang cháº¡y `uvicorn` Ä‘á»ƒ tháº¥y log output.

---

Ä‘ang check log trÃªn docker

---

Xem log Docker:

```bash
docker logs -f <container_name>
```

Hoáº·c náº¿u dÃ¹ng docker-compose:

```bash
docker-compose logs -f
```

Log crawl sáº½ hiá»‡n realtime á»Ÿ Ä‘Ã³, bao gá»“m cáº£ "Data null (keys: ...)" Ä‘á»ƒ debug.

---

âš  [3] Data null, retry 2/3 sau 22.6s...

2025-10-28 07:58:11.470 | INFO     | api.main:crawl_pending:305 -   âš  [4] Data null, retry 2/3 sau 24.7s...

2025-10-28 07:58:42.240 | INFO     | api.main:crawl_pending:305 -   âš  [3] Data null sau 3 retry, skip

2025-10-28 07:58:42.241 | INFO     | api.main:crawl_pending:305 - 

2025-10-28 07:58:42.241 | INFO     | api.main:crawl_pending:305 - [5/2958] Káº¿ hoáº¡ch 9622/KH-BNV nÄƒm 2025 thá»±c hiá»‡n nhiá»‡m vá»¥ vá» phÃ¢n cáº¥p...

2025-10-28 07:58:42.241 | INFO     | api.main:crawl_pending:305 -   URL: https://thuvienphapluat.vn/van-ban/Bo-may-hanh-chinh/Ke-hoach-9622-KH-BNV-2025-thuc-hien-nhiem-vu-ve-phan-cap-phan-quyen-khi-van-hanh-chinh-quyen-02-cap-678248.aspx

2025-10-28 07:58:42.241 | INFO     | api.main:crawl_pending:305 -   â± Delay 3.1s...

2025-10-28 07:58:45.456 | INFO     | api.main:crawl_pending:305 -   âš  [4] Data null sau 3 retry, skip

2025-10-28 07:58:45.456 | INFO     | api.main:crawl_pending:305 - 

2025-10-28 07:58:45.456 | INFO     | api.main:crawl_pending:305 - [6/2958] Nghá»‹ Ä‘á»‹nh 278/2025/NÄ-CP quy Ä‘á»‹nh vá» káº¿t ná»‘i, chia sáº» dá»¯ liá»‡...

2025-10-28 07:58:45.457 | INFO     | api.main:crawl_pending:305 -   URL: https://thuvienphapluat.vn/van-ban/Cong-nghe-thong-tin/Nghi-dinh-278-2025-ND-CP-ket-noi-chia-se-du-lieu-bat-buoc-giua-co-quan-he-thong-chinh-tri-678102.aspx

2025-10-28 07:58:45.457 | INFO     | api.main:crawl_pending:305 -   â± Delay 3.9s...

2025-10-28 07:58:54.374 | INFO     | api.main:crawl_pending:305 -   âš  [5] Data null, retry 1/3 sau 24.6s...

2025-10-28 07:58:58.367 | INFO     | api.main:crawl_pending:305 -   âš  [6] Data null, retry 1/3 sau 24.8s...

2025-10-28 07:59:28.157 | INFO     | api.main:crawl_pending:305 -   âš  [5] Data null, retry 2/3 sau 24.6s...

2025-10-28 07:59:30.834 | INFO     | api.main:crawl_pending:305 -   âš  [6] Data null, retry 2/3 sau 24.7s...

2025-10-28 08:00:02.116 | INFO     | api.main:crawl_pending:305 -   âš  [5] Data null sau 3 retry, skip

---

Log khÃ´ng hiá»‡n "keys: [...]" nghÄ©a lÃ  code chÆ°a update trong Docker. NhÆ°ng váº¥n Ä‘á» chÃ­nh: **toÃ n bá»™ vÄƒn báº£n Ä‘á»u Data null**.

NguyÃªn nhÃ¢n cÃ³ thá»ƒ:
1. **IP bá»‹ cháº·n** (rate limit)
2. **Session háº¿t háº¡n** giá»¯a batch
3. **CAPTCHA xuáº¥t hiá»‡n** nhÆ°ng khÃ´ng bypass Ä‘Æ°á»£c
4. **Timeout quÃ¡ ngáº¯n** (60s vá»›i retry 3x = 60s, 120s, 180s)

Thá»­ tÄƒng timeout ban Ä‘áº§u lÃªn 90s:

```bash
# Trong API call
POST /crawl-pending
{
  "timeout_ms": 90000,
  "concurrency": 1
}
```

Hoáº·c kiá»ƒm tra xem cÃ³ CAPTCHA khÃ´ng báº±ng cÃ¡ch cháº¡y vá»›i `headed=true`:

```bash
POST /crawl-pending
{
  "timeout_ms": 90000,
  "concurrency": 1,
  "headed": true
}
```

Náº¿u váº«n null â†’ cÃ³ thá»ƒ IP bá»‹ cháº·n, cáº§n Ä‘á»•i IP/VPN.

---

request cá»§a api crawl-documents lÃ  gÃ¬

---

Request cá»§a `/crawl-documents`:

```json
{
  "links": [
    {
      "Stt": 1,
      "Url": "https://thuvienphapluat.vn/...",
      "Ten van ban": "TÃªn vÄƒn báº£n"
    }
  ],
  "concurrency": 2,
  "timeout_ms": 30000,
  "reuse_session": false,
  "headed": false,
  "save_per_batch": true
}
```

KhÃ¡c vá»›i `/crawl-pending` (khÃ´ng cáº§n truyá»n links, tá»± query tá»« DB), `/crawl-documents` cáº§n truyá»n array links thá»§ cÃ´ng.

---

Details
422	
Error: Unprocessable Entity

Response body
Download
{
  &quot;detail&quot;: [
    {
      &quot;type&quot;: &quot;json_invalid&quot;,
      &quot;loc&quot;: [
        &quot;body&quot;,
        338
      ],
      &quot;msg&quot;: &quot;JSON decode error&quot;,
      &quot;input&quot;: {},
      &quot;ctx&quot;: {
        &quot;error&quot;: &quot;Invalid control character at&quot;
      }
    }
  ]
}
Response headers
 content-length: 139 
 content-type: application/json 
 date: Tue,28 Oct 2025 08:07:18 GMT 
 server: uvicorn 

{
  &quot;links&quot;: [
    {
      &quot;Stt&quot;: 1,
      &quot;Url&quot;: &quot;https://thuvienphapluat.vn/van-ban/Giao-duc/Thong-tu-21-2025-TT-BGDDT-che-do-tra-tien-luong-day-them-gio-nha-giao-trong-cac-co-so-giao-duc-cong-lap-673797.aspx&quot;,
      &quot;Ten van ban&quot;: &quot;ThÃ´ng tÆ° 21/2025/TT-BGDÄT cháº¿ Ä‘á»™ tráº£ tiá»n lÆ°Æ¡ng dáº¡y thÃªm giá» nhÃ  giÃ¡o trong cÃ¡c cÆ¡ sá»Ÿ giÃ¡o dá»¥c cÃ´ng láº­p
&quot;
    }
  ],
  &quot;concurrency&quot;: 2,
  &quot;timeout_ms&quot;: 30000,
  &quot;reuse_session&quot;: false,
  &quot;headed&quot;: false,
  &quot;save_per_batch&quot;: true
}

---

Lá»—i do kÃ½ tá»± xuá»‘ng dÃ²ng (`\n`) trong "Ten van ban". Fix:

```json
{
  "links": [
    {
      "Stt": 1,
      "Url": "https://thuvienphapluat.vn/van-ban/Giao-duc/Thong-tu-21-2025-TT-BGDDT-che-do-tra-tien-luong-day-them-gio-nha-giao-trong-cac-co-so-giao-duc-cong-lap-673797.aspx",
      "Ten van ban": "ThÃ´ng tÆ° 21/2025/TT-BGDÄT cháº¿ Ä‘á»™ tráº£ tiá»n lÆ°Æ¡ng dáº¡y thÃªm giá» nhÃ  giÃ¡o trong cÃ¡c cÆ¡ sá»Ÿ giÃ¡o dá»¥c cÃ´ng láº­p"
    }
  ],
  "concurrency": 2,
  "timeout_ms": 30000,
  "reuse_session": false,
  "headed": false,
  "save_per_batch": true
}
```

Bá» kÃ½ tá»± xuá»‘ng dÃ²ng á»Ÿ cuá»‘i "Ten van ban".

---

2025-10-28 08:07:53.628 | INFO     | api.main:crawl_documents:374 - Running: python -m tvpl_crawler.crawl_data_fast /tmp/api_links.json /tmp/api_result.json 2 30000 --save-per-batch

Crawl 1 vÄƒn báº£n (concurrency=2, timeout=30s, mode=LOGIN má»—i batch)


âœ“ Started crawl session #11



============================================================

Batch 1/1 - 1 vÄƒn báº£n

============================================================

ğŸ” Login má»›i vá»›i UA: ...Chrome/118.0.0.0 Safari/537.36
postgres

2025-10-28 08:08:06.675 UTC [27] LOG:  checkpoint starting: time

2025-10-28 08:08:09.203 UTC [27] LOG:  checkpoint complete: wrote 25 buffers (0.1%); 0 WAL file(s) added, 0 removed, 0 recycled; write=2.445 s, sync=0.059 s, total=2.529 s; sync files=15, longest=0.052 s, average=0.004 s; distance=147 kB, estimate=153 kB; lsn=0/170574A8, redo lsn=0/17057470
tvpl-api


[1/1] ThÃ´ng tÆ° 21/2025/TT-BGDÄT cháº¿ Ä‘á»™ tráº£ tiá»n lÆ°Æ¡ng dáº¡y thÃªm giá»...

  URL: https://thuvienphapluat.vn/van-ban/Giao-duc/Thong-tu-21-2025-TT-BGDDT-che-do-tra-tien-luong-day-them-gio-nha-giao-trong-cac-co-so-giao-duc-cong-lap-673797.aspx

  â± Delay 3.2s...

  âš  [1] Timeout, retry 1/3 sau 20.2s...

  âœ— [1] Session expired - login required

  ğŸ’¾ ÄÃ£ lÆ°u batch vÃ o Supabase: 0 changed, 0 unchanged


âš ï¸  1 vÄƒn báº£n lá»—i session. Login láº¡i...

[1/1] ThÃ´ng tÆ° 21/2025/TT-BGDÄT cháº¿ Ä‘á»™ tráº£ tiá»n lÆ°Æ¡ng dáº¡y thÃªm giá»... (RETRY)



k retry láº¡i 2 láº§n kia Ã 

---

Váº¥n Ä‘á»: Timeout á»Ÿ retry 1 â†’ nhÆ°ng khÃ´ng retry tiáº¿p â†’ bÃ¡o "Session expired" â†’ retry vá»›i login má»›i.

NguyÃªn nhÃ¢n: Exception "Session expired" Ä‘Æ°á»£c raise trÆ°á»›c khi kiá»ƒm tra retry. Fix logic:

---

ÄÃ£ fix. BÃ¢y giá» check session sau khi cÃ³ data, cho phÃ©p retry Ä‘áº§y Ä‘á»§ 3 láº§n trÆ°á»›c khi bÃ¡o session expired.

---

sao chiá»u nay cháº¡y k crawl Ä‘Æ°á»£c data nÃ o v

---

CÃ³ thá»ƒ do:

1. **IP bá»‹ cháº·n** - thuvienphapluat.vn block IP sau khi crawl nhiá»u
2. **VPN/Proxy issue** - Windscribe Ä‘ang dÃ¹ng cÃ³ thá»ƒ bá»‹ detect
3. **Session/Cookie háº¿t háº¡n** - cáº§n login láº¡i
4. **Website thay Ä‘á»•i** - CAPTCHA máº¡nh hÆ¡n hoáº·c cáº¥u trÃºc HTML Ä‘á»•i

**Kiá»ƒm tra nhanh:**

1. Thá»­ crawl 1 vÄƒn báº£n vá»›i `headed=true` Ä‘á»ƒ xem browser:
```json
POST /crawl-documents
{
  "links": [{"Stt": 1, "Url": "...", "Ten van ban": "..."}],
  "headed": true,
  "timeout_ms": 90000
}
```

2. Hoáº·c test thá»§ cÃ´ng:
```bash
curl https://thuvienphapluat.vn/
```

3. Äá»•i IP/VPN khÃ¡c (dÃ¹ng hide.me thay vÃ¬ Windscribe)

4. TÄƒng delay giá»¯a requests (Ä‘Ã£ cÃ³ 20-25s retry, nhÆ°ng cÃ³ thá»ƒ cáº§n cao hÆ¡n)

Náº¿u váº«n null â†’ cÃ³ thá»ƒ IP bá»‹ blacklist táº¡m thá»i, cáº§n Ä‘á»£i hoáº·c Ä‘á»•i IP.

---

â•‘ Looks like you launched a headed browser without having a XServer running.                     â•‘

â•‘ Set either &#39;headless: true&#39; or use &#39;xvfb-run &lt;your-playwright-app&gt;&#39; before running Playwright. â•‘

â•‘                                                                                                â•‘

â•‘ &lt;3 Playwright Team                                                                             â•‘

â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Call log:

---

Äang cháº¡y trÃªn Docker/server khÃ´ng cÃ³ GUI. KhÃ´ng thá»ƒ dÃ¹ng `headed=true`. 

Äá»ƒ debug, xem log chi tiáº¿t hÆ¡n báº±ng cÃ¡ch thÃªm screenshot:

---

BÃ¢y giá» sáº½ lÆ°u screenshot vÃ o `data/screenshots/` Ä‘á»ƒ debug. Cháº¡y láº¡i vÃ  check folder Ä‘Ã³ xem trang web hiá»ƒn thá»‹ gÃ¬.

Hoáº·c test trá»±c tiáº¿p xem IP cÃ³ bá»‹ cháº·n:
```bash
docker exec -it <container> curl -I https://thuvienphapluat.vn/
```

---

cháº¡y trong terminal Ä‘Æ°á»£c k

---

ÄÆ°á»£c, cháº¡y trá»±c tiáº¿p trong terminal (khÃ´ng qua API):

```bash
# Fetch pending URLs
python -m tvpl_crawler.fetch_pending_urls 10 data/pending.json

# Crawl vá»›i screenshot Ä‘á»ƒ debug
python -m tvpl_crawler.crawl_data_fast data/pending.json data/result.json 1 90000 --save-per-batch
```

Sau Ä‘Ã³ check screenshots trong `data/screenshots/` Ä‘á»ƒ xem trang web hiá»ƒn thá»‹ gÃ¬ (CAPTCHA, blocked, hay data null).

Náº¿u trÃªn Docker:
```bash
docker exec -it <container> python -m tvpl_crawler.crawl_data_fast /tmp/test.json /tmp/result.json 1 90000
```

---

má»Ÿ headed = true trong terminal cháº¡y python -m tvpl_crawler.fetch_pending_urls 1 data/pending.json

---

`fetch_pending_urls` chá»‰ query DB, khÃ´ng crawl nÃªn khÃ´ng cÃ³ `headed`. Äá»ƒ má»Ÿ browser, dÃ¹ng `crawl_data_fast`:

```bash
# Fetch 1 URL
python -m tvpl_crawler.fetch_pending_urls 1 data/pending.json

# Crawl vá»›i headed=true
python -m tvpl_crawler.crawl_data_fast data/pending.json data/result.json 1 90000 --headed
```

Flag `--headed` sáº½ hiá»ƒn thá»‹ browser Ä‘á»ƒ xem trang web cÃ³ CAPTCHA, bá»‹ block, hay load bÃ¬nh thÆ°á»ng.

---

tÃ´i tháº¥y má»Ÿ lÃªn nhá»¯ng k láº¥y dá»¯ liá»‡u lÃ  sao  python -m tvpl_crawler.crawl_data_fast data/pending1.json data/result.json 1 60000 --headed
&gt;&gt; 
Fetched 1 pending URLs
Saved to data/pending.json
Crawl 1 vÄƒn báº£n (concurrency=1, timeout=60s, mode=LOGIN má»—i batch)


============================================================
Batch 1/1 - 1 vÄƒn báº£n
============================================================
ğŸ” Login má»›i vá»›i UA: ...Chrome/118.0.0.0 Safari/537.36

[1/1] Quyáº¿t Ä‘á»‹nh 014/2025/QÄ-UBND quy Ä‘á»‹nh chá»©c nÄƒng, nhiá»‡m vá»¥ vÃ  ...
  URL: https://thuvienphapluat.vn/van-ban/Thuong-mai/Quyet-dinh-014-2025-QD-UBND-chuc-nang-nhiem-vu-Chi-Cuc-Quan-ly-thi-truong-Dak-Lak-674723.aspx
  â± Delay 3.7s...
  âš  [1] Data null (keys: []), retry 1/3 sau 24.8s...
  âš  [1] Data null (keys: []), retry 2/3 sau 23.4s...
  âš  [1] Data null sau 3 retry (keys: []), skip

============================================================
Crawl xong 1/1 vÄƒn báº£n
Káº¿t quáº£: data\result.json

---

`keys: []` nghÄ©a lÃ  `doc_info` rá»—ng hoÃ n toÃ n â†’ khÃ´ng extract Ä‘Æ°á»£c gÃ¬. CÃ³ thá»ƒ:

1. **CAPTCHA khÃ´ng bypass Ä‘Æ°á»£c**
2. **Trang khÃ´ng load ká»‹p**
3. **Selector thay Ä‘á»•i**

Khi browser má»Ÿ, báº¡n tháº¥y gÃ¬ trÃªn mÃ n hÃ¬nh? 

- CÃ³ CAPTCHA khÃ´ng?
- Trang cÃ³ load Ä‘áº§y Ä‘á»§ khÃ´ng?
- Tab4 cÃ³ hiá»ƒn thá»‹ khÃ´ng?

Äá»ƒ debug chi tiáº¿t hÆ¡n, thÃªm log vÃ o `playwright_extract_simple.py`:

---

Cháº¡y láº¡i vá»›i `--headed` vÃ  xem log debug:

```bash
python -m tvpl_crawler.crawl_data_fast data/pending1.json data/result.json 1 60000 --headed
```

Log sáº½ hiá»‡n:
- `viewingDocument found: True/False`
- `Extracted doc_info keys: [...]`
- `tab4 HTML length: ...`
- `Total relations: ...`

Äá»ƒ biáº¿t chÃ­nh xÃ¡c bÆ°á»›c nÃ o bá»‹ lá»—i.

---

k cÃ³ capcha, load Ä‘áº©y Ä‘á»§ , cÃ³ tab 4 :
[1/1] Quyáº¿t Ä‘á»‹nh 014/2025/QÄ-UBND quy Ä‘á»‹nh chá»©c nÄƒng, nhiá»‡m vá»¥ vÃ  ...
  URL: https://thuvienphapluat.vn/van-ban/Thuong-mai/Quyet-dinh-014-2025-QD-UBND-chuc-nang-nhiem-vu-Chi-Cuc-Quan-ly-thi-truong-Dak-Lak-674723.aspx
  â± Delay 3.7s...
  [DEBUG] viewingDocument found: True
  [DEBUG] Extracted doc_info keys: [&#39;Sá»‘ hiá»‡u&#39;, &#39;Loáº¡i vÄƒn báº£n&#39;, &#39;LÄ©nh vá»±c, ngÃ nh&#39;, &#39;NÆ¡i ban hÃ nh&#39;, &#39;NgÆ°á»i kÃ½&#39;, &#39;NgÃ y ban hÃ nh&#39;, &#39;NgÃ y hiá»‡u lá»±c&#39;, &#39;NgÃ y Ä‘Äƒng&#39;, &#39;Sá»‘ cÃ´ng bÃ¡o&#39;, &#39;TÃ¬nh tráº¡ng&#39;]
  [DEBUG] tab4 HTML length: 74566
  [DEBUG] Total relations: 8
  âš  [1] Data null (keys: []), retry 1/3 sau 24.1s...
  âœ— [1] Page.goto: net::ERR_CONNECTION_CLOSED at https://thuvienphapluat.vn/van-ban/Thuo

============================================================
Crawl xong 1/1 vÄƒn báº£n
Káº¿t quáº£: data\result.json
============================

---

Váº¥n Ä‘á» rÃµ rÃ ng: 
- **Láº§n 1**: Extract thÃ nh cÃ´ng (`doc_info keys: 10 keys`, `8 relations`)
- **NhÆ°ng** check `_has_valid_doc_info()` tráº£ vá» `False` â†’ retry
- **Retry**: Connection closed (cÃ³ thá»ƒ do close page sá»›m)

Váº¥n Ä‘á» á»Ÿ hÃ m `_has_valid_doc_info()`:

---

Cháº¡y láº¡i Ä‘á»ƒ xem `_has_valid_doc_info` nháº­n Ä‘Æ°á»£c gÃ¬:

```bash
python -m tvpl_crawler.crawl_data_fast data/pending1.json data/result.json 1 60000 --headed
```

---

Batch 1/1 - 1 vÄƒn báº£n
============================================================
ğŸ” Login má»›i vá»›i UA: ...like Gecko) Edge/118.0.2088.76

[1/1] Quyáº¿t Ä‘á»‹nh 014/2025/QÄ-UBND quy Ä‘á»‹nh chá»©c nÄƒng, nhiá»‡m vá»¥ vÃ  ...
  URL: https://thuvienphapluat.vn/van-ban/Thuong-mai/Quyet-dinh-014-2025-QD-UBND-chuc-nang-nhiem-vu-Chi-Cuc-Quan-ly-thi-truong-Dak-Lak-674723.aspx
  â± Delay 2.9s...
  [DEBUG] viewingDocument found: True
  [DEBUG] Extracted doc_info keys: [&#39;Sá»‘ hiá»‡u&#39;, &#39;Loáº¡i vÄƒn báº£n&#39;, &#39;LÄ©nh vá»±c, ngÃ nh&#39;, &#39;NÆ¡i ban hÃ nh&#39;, &#39;NgÆ°á»i kÃ½&#39;, &#39;NgÃ y ban hÃ nh&#39;, &#39;NgÃ y hiá»‡u lá»±c&#39;, &#39;NgÃ y Ä‘Äƒng&#39;, &#39;Sá»‘ cÃ´ng bÃ¡o&#39;, &#39;TÃ¬nh tráº¡ng&#39;]
  [DEBUG] tab4 HTML length: 16357
  [DEBUG] Total relations: 0
  [DEBUG] _has_valid_doc_info: False, doc_info: {}
  âœ— [1] Session expired - login required

âš ï¸  1 vÄƒn báº£n lá»—i session. Login láº¡i...
[1/1] Quyáº¿t Ä‘á»‹nh 014/2025/QÄ-UBND quy Ä‘á»‹nh chá»©c nÄƒng, nhiá»‡m vá»¥ vÃ  ... (RETRY)
  [DEBUG] viewingDocument found: True
  [DEBUG] Extracted doc_info keys: [&#39;Sá»‘ hiá»‡u&#39;, &#39;Loáº¡i vÄƒn báº£n&#39;, &#39;LÄ©nh vá»±c, ngÃ nh&#39;, &#39;NÆ¡i ban hÃ nh&#39;, &#39;NgÆ°á»i kÃ½&#39;, &#39;NgÃ y ban hÃ nh&#39;, &#39;NgÃ y hiá»‡u lá»±c&#39;, &#39;NgÃ y Ä‘Äƒng&#39;, &#39;Sá»‘ cÃ´ng bÃ¡o&#39;, &#39;TÃ¬nh tráº¡ng&#39;]
  [DEBUG] tab4 HTML length: 74566
  [DEBUG] Total relations: 8
  [DEBUG] _has_valid_doc_info: False, doc_info: {}
  âš  [1] Data null, retry 1/3 sau 20.3s...
  [DEBUG] viewingDocument found: True
  [DEBUG] Extracted doc_info keys: [&#39;Sá»‘ hiá»‡u&#39;, &#39;Loáº¡i vÄƒn báº£n&#39;, &#39;LÄ©nh vá»±c, ngÃ nh&#39;, &#39;NÆ¡i ban hÃ nh&#39;, &#39;NgÆ°á»i kÃ½&#39;, &#39;NgÃ y ban hÃ nh&#39;, &#39;NgÃ y hiá»‡u lá»±c&#39;, &#39;NgÃ y Ä‘Äƒng&#39;, &#39;Sá»‘ cÃ´ng bÃ¡o&#39;, &#39;TÃ¬nh tráº¡ng&#39;]
  [DEBUG] tab4 HTML length: 74566
  [DEBUG] Total relations: 8
  [DEBUG] _has_valid_doc_info: False, doc_info: {}
  âš  [1] Data null, retry 2/3 sau 22.1s...

---

TÃ¬m tháº¥y bug! 

- `extract_tab4_simple_async()` tráº£ vá» `doc_info` cÃ³ 10 keys
- NhÆ°ng `_has_valid_doc_info()` nháº­n `doc_info: {}`

â†’ `data.get("doc_info", {})` tráº£ vá» `{}` thay vÃ¬ doc_info thá»±c táº¿!

Váº¥n Ä‘á»: `extract_luoc_do_async()` khÃ´ng tráº£ vá» Ä‘Ãºng format. Check:

---

ÄÃ£ fix: thay `**doc_info` (spread) thÃ nh `"doc_info": doc_info` (nested). Cháº¡y láº¡i:

```bash
python -m tvpl_crawler.crawl_data_fast data/pending1.json data/result.json 1 60000 --headed
```

---

oke rá»“i Ä‘Ã³ giá» tÃ´i dÃ¹ng api crawl-pending ngon r dk

---

Tá»‘t! BÃ¢y giá» cÃ³ thá»ƒ crawl pending documents qua API:

```bash
POST /crawl-pending
{
  "limit": 100,
  "concurrency": 2,
  "timeout_ms": 60000,
  "save_per_batch": true
}
```

Nhá»›:
- TÄƒng `timeout_ms` náº¿u nhiá»u timeout
- Giáº£m `concurrency` náº¿u bá»‹ rate limit
- DÃ¹ng VPN hide.me thay vÃ¬ Windscribe náº¿u cáº§n káº¿t ná»‘i Supabase
- Cháº¡y `cleanup_sessions` náº¿u cÃ³ session RUNNING cÅ©

---

crawl xong má»—i batch lÆ°u vÃ o db Ã 

---

ÄÃºng! Khi `save_per_batch=true`:

1. Crawl 15 vÄƒn báº£n (1 batch)
2. LÆ°u ngay vÃ o Supabase:
   - `documents_finals` - thÃ´ng tin vÄƒn báº£n
   - `document_versions` - version tracking
   - `document_relations` - quan há»‡ tab4
   - `document_files` - file tab8
   - `doc_urls.status='completed'` - Ä‘Ã¡nh dáº¥u Ä‘Ã£ crawl
3. Tiáº¿p tá»¥c batch tiáº¿p theo

Náº¿u `save_per_batch=false` â†’ chá»‰ lÆ°u JSON, pháº£i import thá»§ cÃ´ng sau.

---

sao cá»© bá»‹ login require , tÆ°á»Ÿng cÃ³ mode login vÃ o khi bá»‹ diss ra rá»“i , vÃ  táº¯t debug cho tÃ´i 

[14/2958] Quyáº¿t Ä‘á»‹nh 75/2025/QÄ-UBND quy Ä‘á»‹nh chá»©c nÄƒng, nhiá»‡m vá»¥, quy...

  URL: https://thuvienphapluat.vn/van-ban/Bo-may-hanh-chinh/Quyet-dinh-75-2025-QD-UBND-chuc-nang-nhiem-vu-va-co-cau-to-chuc-Thanh-tra-Nghe-An-677945.aspx

  â± Delay 2.9s...

  [DEBUG] viewingDocument found: True

  [DEBUG] viewingDocument found: True

  [DEBUG] Extracted doc_info keys: [&#39;Sá»‘ hiá»‡u&#39;, &#39;Loáº¡i vÄƒn báº£n&#39;, &#39;LÄ©nh vá»±c, ngÃ nh&#39;, &#39;NÆ¡i ban hÃ nh&#39;, &#39;NgÆ°á»i kÃ½&#39;, &#39;NgÃ y ban hÃ nh&#39;, &#39;NgÃ y hiá»‡u lá»±c&#39;, &#39;NgÃ y Ä‘Äƒng&#39;, &#39;Sá»‘ cÃ´ng bÃ¡o&#39;, &#39;TÃ¬nh tráº¡ng&#39;]

  [DEBUG] tab4 HTML length: 16349

  [DEBUG] Total relations: 0

  [DEBUG] tab4_data keys: [&#39;doc_info&#39;, &#39;tab4_relations&#39;, &#39;tab4_summary&#39;, &#39;tab4_total_relations&#39;]

  [DEBUG] doc_info from tab4_data: {&#39;Sá»‘ hiá»‡u&#39;: &#39;75/2025/QÄ-UBND&#39;, &#39;Loáº¡i vÄƒn báº£n&#39;: &#39;Quyáº¿t Ä‘á»‹nh&#39;, &#39;LÄ©nh vá»±c, ngÃ nh&#39;: &#39;Bá»™ mÃ¡y hÃ nh chÃ­nh&#39;, &#39;NÆ¡i ban hÃ nh&#39;: &#39;Tá»‰nh Nghá»‡ An&#39;, &#39;NgÆ°á»i kÃ½&#39;: &#39;LÃª Há»“ng Vinh&#39;, &#39;NgÃ y ban hÃ nh&#39;: &#39;21/10/2025&#39;, &#39;NgÃ y hiá»‡u lá»±c&#39;: &#39;ÄÃ£ biáº¿t&#39;, &#39;NgÃ y Ä‘Äƒng&#39;: &#39;Dá»¯ liá»‡u Ä‘ang cáº­p nháº­t&#39;, &#39;Sá»‘ cÃ´ng bÃ¡o&#39;: &#39;Dá»¯ liá»‡u Ä‘ang cáº­p nháº­t&#39;, &#39;TÃ¬nh tráº¡ng&#39;: &#39;ÄÃ£ biáº¿t&#39;}

  [DEBUG] Extracted doc_info keys: [&#39;Sá»‘ hiá»‡u&#39;, &#39;Loáº¡i vÄƒn báº£n&#39;, &#39;LÄ©nh vá»±c, ngÃ nh&#39;, &#39;NÆ¡i ban hÃ nh&#39;, &#39;NgÆ°á»i kÃ½&#39;, &#39;NgÃ y ban hÃ nh&#39;, &#39;NgÃ y hiá»‡u lá»±c&#39;, &#39;NgÃ y Ä‘Äƒng&#39;, &#39;Sá»‘ cÃ´ng bÃ¡o&#39;, &#39;TÃ¬nh tráº¡ng&#39;]

  [DEBUG] tab4 HTML length: 16399

  [DEBUG] Total relations: 0

  [DEBUG] tab4_data keys: [&#39;doc_info&#39;, &#39;tab4_relations&#39;, &#39;tab4_summary&#39;, &#39;tab4_total_relations&#39;]

  [DEBUG] doc_info from tab4_data: {&#39;Sá»‘ hiá»‡u&#39;: &#39;59/2025/QÄ-UBND&#39;, &#39;Loáº¡i vÄƒn báº£n&#39;: &#39;Quyáº¿t Ä‘á»‹nh&#39;, &#39;LÄ©nh vá»±c, ngÃ nh&#39;: &#39;TÃ i chÃ­nh nhÃ  nÆ°á»›c&#39;, &#39;NÆ¡i ban hÃ nh&#39;: &#39;ThÃ nh phá»‘ HÃ  Ná»™i&#39;, &#39;NgÆ°á»i kÃ½&#39;: &#39;TrÆ°Æ¡ng Viá»‡t DÅ©ng&#39;, &#39;NgÃ y ban hÃ nh&#39;: &#39;25/09/2025&#39;, &#39;NgÃ y hiá»‡u lá»±c&#39;: &#39;ÄÃ£ biáº¿t&#39;, &#39;NgÃ y Ä‘Äƒng&#39;: &#39;Dá»¯ liá»‡u Ä‘ang cáº­p nháº­t&#39;, &#39;Sá»‘ cÃ´ng bÃ¡o&#39;: &#39;Dá»¯ liá»‡u Ä‘ang cáº­p nháº­t&#39;, &#39;TÃ¬nh tráº¡ng&#39;: &#39;ÄÃ£ biáº¿t&#39;}

---

Táº¯t debug vÃ  fix session expired:

---

ÄÃ£ táº¯t debug vÃ  bá» check session expired (vÃ¬ nÃ³ gÃ¢y false positive). Session sáº½ tá»± Ä‘á»™ng login láº¡i khi thá»±c sá»± háº¿t háº¡n.

---

khi má»Ÿ login vÃ o má»—i batch xong crawl, khi mÃ  trong batch Ä‘Ã³ háº¿t háº¡n thÃ¬ sáº½ login láº¡i Ä‘Ãºng k

---

KhÃ´ng, hiá»‡n táº¡i khÃ´ng tá»± Ä‘á»™ng login láº¡i giá»¯a batch. Logic:

1. **Login má»›i** â†’ crawl 15 vÄƒn báº£n (1 batch)
2. Náº¿u session háº¿t háº¡n giá»¯a batch â†’ **lá»—i "Session expired"** â†’ vÄƒn báº£n Ä‘Ã³ bá»‹ skip
3. Sau khi crawl xong táº¥t cáº£ batch â†’ **retry** cÃ¡c vÄƒn báº£n lá»—i session vá»›i login má»›i

Äá»ƒ login láº¡i ngay khi háº¿t háº¡n giá»¯a batch, cáº§n thÃªm logic phá»©c táº¡p hÆ¡n. Hiá»‡n táº¡i cÃ¡ch Ä‘Æ¡n giáº£n nháº¥t:

- DÃ¹ng `--reuse-session` Ä‘á»ƒ giá»¯ session lÃ¢u hÆ¡n
- Hoáº·c giáº£m `BATCH_SIZE` tá»« 15 xuá»‘ng 10 Ä‘á»ƒ session khÃ´ng háº¿t háº¡n

Hoáº·c báº¡n muá»‘n tÃ´i thÃªm auto-relogin giá»¯a batch?

---

nhÆ°ng mÃ  khi nÃ£y crawl , má»›i login vÃ o chÆ°a Ä‘Æ°á»£c 10p vÃ  session expired thÃ¬ lÃ  k Ä‘Ãºng

---

ÄÃºng, vá»«a login xong <10 phÃºt mÃ  bÃ¡o "Session expired" lÃ  **false positive**. 

NguyÃªn nhÃ¢n: Code Ä‘Ã£ bá» check `check_login_required()` rá»“i, nhÆ°ng cÃ³ thá»ƒ cÃ²n chá»— khÃ¡c. Kiá»ƒm tra láº¡i:

---

TÃ¬m tháº¥y! HÃ m `crawl_one()` (retry session expired) váº«n cÃ²n check `check_login_required()` á»Ÿ dÃ²ng 267-271. Bá» nÃ³ Ä‘i:

---

ÄÃ£ bá» check session expired. BÃ¢y giá» sáº½ khÃ´ng cÃ²n false positive "Session expired" ná»¯a.

---

nhÆ°ng mÃ  k Ä‘Æ°á»£c, chá»‰ khi login má»›i láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u

---

Váº­y cáº§n giá»¯ check session nhÆ°ng chá»‰ khi thá»±c sá»± cáº§n login. ThÃªm láº¡i nhÆ°ng chá»‰ check khi data null:

---

BÃ¢y giá» chá»‰ check session khi data null â†’ náº¿u thá»±c sá»± cáº§n login thÃ¬ sáº½ retry vá»›i session má»›i, cÃ²n náº¿u data OK thÃ¬ khÃ´ng check.

---

api crawl-pending khi cháº¡y sáº½ query láº¥y danh sÃ¡ch cÃ¡c url cÃ³ status lÃ  pending Ä‘á»ƒ query Ã 

---

ÄÃºng! `/crawl-pending` hoáº¡t Ä‘á»™ng nhÆ° sau:

1. **Query DB** â†’ láº¥y URLs cÃ³ `status='pending'` (sáº¯p xáº¿p theo `priority DESC`)
2. **LÆ°u vÃ o file temp** â†’ `/tmp/api_pending_links.json`
3. **Gá»i subprocess** â†’ `crawl_data_fast` crawl cÃ¡c URLs Ä‘Ã³
4. **LÆ°u tá»«ng batch** â†’ `save_per_batch=true` â†’ update `status='completed'` cho URLs Ä‘Ã£ crawl thÃ nh cÃ´ng
5. **URLs lá»—i** â†’ giá»¯ nguyÃªn `status='pending'` â†’ sáº½ crawl láº¡i láº§n sau

Váº­y má»—i láº§n gá»i API sáº½ chá»‰ crawl cÃ¡c vÄƒn báº£n chÆ°a hoÃ n thÃ nh.

---

file táº¡m kia lÆ°u á»Ÿ Ä‘Ã¢u

---

File táº¡m lÆ°u á»Ÿ:

**Windows:**
```
C:\Users\<username>\AppData\Local\Temp\api_pending_links.json
C:\Users\<username>\AppData\Local\Temp\api_pending_result.json
```

**Linux/Docker:**
```
/tmp/api_pending_links.json
/tmp/api_pending_result.json
```

ÄÆ°á»£c táº¡o bá»Ÿi `Path(tempfile.gettempdir())` trong code. Sau khi crawl xong sáº½ tá»± Ä‘á»™ng xÃ³a.

---

file query Ä‘á»ƒ tÃ´i Ä‘Ã¢u Ä‘á»ƒ tÃ´i táº¡o láº¡i cÃ¡c báº£ng trong db , giá» tÃ´i chuyá»ƒn sang db trÃªn sv cÃ´ng ty

---

TÃ¬m file SQL schema:

---

File nÃ y lÃ  schema cÅ©. Báº¡n Ä‘ang dÃ¹ng schema má»›i vá»›i cÃ¡c báº£ng:
- `doc_urls`
- `documents_finals`
- `document_versions`
- `document_relations`
- `document_files`
- `crawl_sessions`

Táº¡o file schema má»›i tá»« Supabase hiá»‡n táº¡i:

---

Create current schema SQL file for migration to company database

---

ÄÃ£ táº¡o file `current_schema.sql` vá»›i schema hiá»‡n táº¡i. Cháº¡y file nÃ y trÃªn DB cÃ´ng ty Ä‘á»ƒ táº¡o láº¡i cÃ¡c báº£ng.

---

giá» tÃ´i sáº½ crawl down cáº£ file ná»¯a , vÃ  chá»‰ táº£i file docs thÃ´i . Pháº£i táº¡o bucket storage trÃªn supabase Ã 

---

CÃ³ 2 cÃ¡ch:

**1. Supabase Storage (khuyáº¿n nghá»‹ náº¿u dÃ¹ng Supabase):**
- Táº¡o bucket trÃªn Supabase Dashboard â†’ Storage â†’ New bucket
- TÃªn bucket: `documents` hoáº·c `tvpl-files`
- Public/Private tÃ¹y nhu cáº§u

**2. LÆ°u local (Ä‘Æ¡n giáº£n hÆ¡n):**
- LÆ°u vÃ o folder `data/downloads/`
- Chá»‰ lÆ°u path vÃ o DB

Báº¡n muá»‘n dÃ¹ng cÃ¡ch nÃ o? Náº¿u Supabase Storage, tÃ´i sáº½ thÃªm code upload. Náº¿u local, chá»‰ cáº§n update `download_status` vÃ  `local_path` trong báº£ng `document_files`.

---

giá» tÃ´i muá»‘n khi crawl thÃ¬ down cáº£ link ná»¯a vÃ  chá»‰ láº¥y vÃ  downlink doc thÃ´i, tÃ´i vá»«a táº¡o bucket rá»“i , giá» crawl-pending cÃ³ nÃªn thÃªm mode down link ná»¯a k

---

NÃªn tÃ¡ch riÃªng:

1. **`/crawl-pending`** - Chá»‰ crawl metadata + relations (nhÆ° hiá»‡n táº¡i)
2. **`/download-pending`** - Download files tá»« `document_files` cÃ³ `download_status='pending'`

LÃ½ do:
- Crawl metadata nhanh (2-4s/doc)
- Download file cháº­m (10-30s/file)
- TÃ¡ch ra dá»… retry, dá»… scale

TÃ´i táº¡o endpoint `/download-pending` Ä‘á»ƒ download files .doc tá»« báº£ng `document_files`?

---

oke , vÃ  nÃ³ chá»‰ down nhá»¯ng file cÃ³ download_status lÃ  pending thÃ´i Ä‘Ãºng k

---

ÄÃºng! Logic:

1. Query `document_files` WHERE `download_status='pending'` AND `file_type='doc'` (hoáº·c 'docx')
2. Download tá»«ng file â†’ upload lÃªn Supabase Storage
3. Update `download_status='downloaded'`, `local_path='bucket/path'`, `downloaded_at=NOW()`
4. Náº¿u lá»—i â†’ `download_status='failed'`

Táº¡o endpoint `/download-pending` ngay:

---

ÄÃ£ táº¡o endpoint `/download-pending`. Gá»i API:

```bash
POST /download-pending
{
  "limit": 100,
  "file_types": ["doc", "docx"]
}
```

Sáº½ download tá»‘i Ä‘a 100 files .doc/.docx cÃ³ `download_status='pending'` vÃ  upload lÃªn bucket `documents` trÃªn Supabase.

---

nÃ³ sáº½ lÆ°u vÃ o Ä‘Ã¢u , bucket nÃ o , k cáº§n config Ã 

---

Äang hardcode bucket name lÃ  `documents`. Cáº§n config:

---

ÄÃ£ thÃªm config `SUPABASE_BUCKET=documents` vÃ o `.env`. CÃ³ thá»ƒ Ä‘á»•i tÃªn bucket báº±ng cÃ¡ch sá»­a biáº¿n nÃ y.

---

do lÃºc crawl vá» cÃ¡c trÆ°á»ng file_type cá»§a cÃ¡c vÄƒn báº£n Ä‘á»‹nh dáº¡ng chÆ°a rÃµ hiá»‡n táº¡i chá»‰ cÃ³ pdf vÃ  other. CÃ¡c file mÃ  cÃ³ file_name lÃ  Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t thÆ°á»ng lÃ  file doc

---

Fix logic phÃ¡t hiá»‡n file type trong `import_supabase_v2.py`:

---

ÄÃ£ fix. BÃ¢y giá» file cÃ³ tÃªn "Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t" sáº½ Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u `file_type='doc'` thay vÃ¬ `other`.

---

File &quot;/usr/local/lib/python3.10/dist-packages/starlette/_exception_handler.py&quot;, line 42, in wrapped_app

    await app(scope, receive, sender)

          â”‚   â”‚      â”‚        â”” &lt;function wrap_app_handling_exceptions.&lt;locals&gt;.wrapped_app.&lt;locals&gt;.sender at 0x7d0922606290&gt;

          â”‚   â”‚      â”” &lt;bound method RequestResponseCycle.receive of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x7d09226...

          â”‚   â”” {&#39;type&#39;: &#39;http&#39;, &#39;asgi&#39;: {&#39;version&#39;: &#39;3.0&#39;, &#39;spec_version&#39;: &#39;2.3&#39;}, &#39;http_version&#39;: &#39;1.1&#39;, &#39;server&#39;: (&#39;172.21.0.5&#39;, 8000), &#39;c...

          â”” &lt;function request_response.&lt;locals&gt;.app.&lt;locals&gt;.app at 0x7d0922606200&gt;

  File &quot;/usr/local/lib/python3.10/dist-packages/fastapi/routing.py&quot;, line 110, in app

    response = await f(request)

                     â”‚ â”” &lt;starlette.requests.Request object at 0x7d092260a440&gt;

                     â”” &lt;function get_request_handler.&lt;locals&gt;.app at 0x7d0922604670&gt;

  File &quot;/usr/local/lib/python3.10/dist-packages/fastapi/routing.py&quot;, line 390, in app

    raw_response = await run_endpoint_function(

                         â”” &lt;function run_endpoint_function at 0x7d0925af1cf0&gt;

  File &quot;/usr/local/lib/python3.10/dist-packages/fastapi/routing.py&quot;, line 289, in run_endpoint_function

    return await dependant.call(**values)

                 â”‚         â”‚      â”” {&#39;limit&#39;: 1, &#39;file_types&#39;: [&#39;doc&#39;, &#39;docx&#39;]}

                 â”‚         â”” &lt;function download_pending at 0x7d09226043a0&gt;

---

Thiáº¿u import `httpx`. Fix:

---

ÄÃ£ fix import. Cháº¡y láº¡i API.

---

â”‚    â”‚   â”” {&#39;type&#39;: &#39;http&#39;, &#39;asgi&#39;: {&#39;version&#39;: &#39;3.0&#39;, &#39;spec_version&#39;: &#39;2.3&#39;}, &#39;http_version&#39;: &#39;1.1&#39;, &#39;server&#39;: (&#39;172.21.0.5&#39;, 8000), &#39;c...

                 â”‚    â”” &lt;fastapi.applications.FastAPI object at 0x7fe2ac12c040&gt;

                 â”” &lt;uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x7fe2ac614ac0&gt;

  File &quot;/usr/local/lib/python3.10/dist-packages/fastapi/applications.py&quot;, line 1134, in __call__

    await super().__call__(scope, receive, send)

                           â”‚      â”‚        â”” &lt;bound method RequestResponseCycle.send of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x7fe2a7dfcb...

---

Cáº§n xem full error. CÃ³ thá»ƒ do:

1. **httpx chÆ°a cÃ i** - thÃªm vÃ o requirements
2. **Supabase storage API sai**
3. **Bucket chÆ°a táº¡o**

ThÃªm httpx vÃ o requirements:

---

httpx Ä‘Ã£ cÃ³. Váº¥n Ä‘á» cÃ³ thá»ƒ lÃ  Supabase storage API. Kiá»ƒm tra bucket Ä‘Ã£ táº¡o chÆ°a vÃ  sá»­a code:

---

ÄÃ£ fix API call. Náº¿u váº«n lá»—i, check:

1. Bucket `documents` Ä‘Ã£ táº¡o trÃªn Supabase chÆ°a?
2. Bucket cÃ³ public hay private?
3. Service role key cÃ³ quyá»n upload khÃ´ng?

---

bucket lÃ  tvpl-files mÃ 

---

ÄÃ£ cÃ³ `SUPABASE_BUCKET=tvpl-files` rá»“i. Restart API Ä‘á»ƒ load láº¡i env:

```bash
docker-compose restart tvpl-api
```

Hoáº·c náº¿u cháº¡y local:
```bash
# Stop vÃ  start láº¡i uvicorn
```

---

tvpl-api | 2025-10-28 16:48:30.250 | 2025-10-28 09:48:30.250 | INFO     | api.main:download_pending:422 - Found 1 pending files to download
tvpl-api | 2025-10-28 16:48:30.344 | 2025-10-28 09:48:30.339 | ERROR    | api.main:download_pending:477 - /download-pending failed
tvpl-api | 2025-10-28 16:48:30.344 | Traceback (most recent call last):
tvpl-api | 2025-10-28 16:48:30.345 | 
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/bin/uvicorn&quot;, line 7, in &lt;module&gt;
tvpl-api | 2025-10-28 16:48:30.345 |     sys.exit(main())
tvpl-api | 2025-10-28 16:48:30.345 |     â”‚   â”‚    â”” &lt;Command main&gt;
tvpl-api | 2025-10-28 16:48:30.345 |     â”‚   â”” &lt;built-in function exit&gt;
tvpl-api | 2025-10-28 16:48:30.345 |     â”” &lt;module &#39;sys&#39; (built-in)&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/click/core.py&quot;, line 1462, in __call__
tvpl-api | 2025-10-28 16:48:30.345 |     return self.main(*args, **kwargs)
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚    â”‚     â”‚       â”” {}
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚    â”‚     â”” ()
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚    â”” &lt;function Command.main at 0x765d5802a710&gt;
tvpl-api | 2025-10-28 16:48:30.345 |            â”” &lt;Command main&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/click/core.py&quot;, line 1383, in main
tvpl-api | 2025-10-28 16:48:30.345 |     rv = self.invoke(ctx)
tvpl-api | 2025-10-28 16:48:30.345 |          â”‚    â”‚      â”” &lt;click.core.Context object at 0x765d58c2baf0&gt;
tvpl-api | 2025-10-28 16:48:30.345 |          â”‚    â”” &lt;function Command.invoke at 0x765d5802a5f0&gt;
tvpl-api | 2025-10-28 16:48:30.345 |          â”” &lt;Command main&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/click/core.py&quot;, line 1246, in invoke
tvpl-api | 2025-10-28 16:48:30.345 |     return ctx.invoke(self.callback, **ctx.params)
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚   â”‚      â”‚    â”‚           â”‚   â”” {&#39;host&#39;: &#39;0.0.0.0&#39;, &#39;port&#39;: 8000, &#39;access_log&#39;: False, &#39;app&#39;: &#39;api.main:app&#39;, &#39;uds&#39;: None, &#39;fd&#39;: None, &#39;reload&#39;: False, &#39;relo...
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚   â”‚      â”‚    â”‚           â”” &lt;click.core.Context object at 0x765d58c2baf0&gt;
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚   â”‚      â”‚    â”” &lt;function main at 0x765d57def640&gt;
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚   â”‚      â”” &lt;Command main&gt;
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚   â”” &lt;function Context.invoke at 0x765d58029990&gt;
tvpl-api | 2025-10-28 16:48:30.345 |            â”” &lt;click.core.Context object at 0x765d58c2baf0&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/click/core.py&quot;, line 814, in invoke
tvpl-api | 2025-10-28 16:48:30.345 |     return callback(*args, **kwargs)
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚         â”‚       â”” {&#39;host&#39;: &#39;0.0.0.0&#39;, &#39;port&#39;: 8000, &#39;access_log&#39;: False, &#39;app&#39;: &#39;api.main:app&#39;, &#39;uds&#39;: None, &#39;fd&#39;: None, &#39;reload&#39;: False, &#39;relo...
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚         â”” ()
tvpl-api | 2025-10-28 16:48:30.345 |            â”” &lt;function main at 0x765d57def640&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/uvicorn/main.py&quot;, line 423, in main
tvpl-api | 2025-10-28 16:48:30.345 |     run(
tvpl-api | 2025-10-28 16:48:30.345 |     â”” &lt;function run at 0x765d57f0dab0&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/uvicorn/main.py&quot;, line 593, in run
tvpl-api | 2025-10-28 16:48:30.345 |     server.run()
tvpl-api | 2025-10-28 16:48:30.345 |     â”‚      â”” &lt;function Server.run at 0x765d5811a560&gt;
tvpl-api | 2025-10-28 16:48:30.345 |     â”” &lt;uvicorn.server.Server object at 0x765d57ddef50&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/uvicorn/server.py&quot;, line 67, in run
tvpl-api | 2025-10-28 16:48:30.345 |     return asyncio_run(self.serve(sockets=sockets), loop_factory=self.config.get_loop_factory())
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚           â”‚    â”‚             â”‚                      â”‚    â”‚      â”” &lt;function Config.get_loop_factory at 0x765d5807a200&gt;
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚           â”‚    â”‚             â”‚                      â”‚    â”” &lt;uvicorn.config.Config object at 0x765d57ed7970&gt;
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚           â”‚    â”‚             â”‚                      â”” &lt;uvicorn.server.Server object at 0x765d57ddef50&gt;
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚           â”‚    â”‚             â”” None
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚           â”‚    â”” &lt;function Server.serve at 0x765d5811a5f0&gt;
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚           â”” &lt;uvicorn.server.Server object at 0x765d57ddef50&gt;
tvpl-api | 2025-10-28 16:48:30.345 |            â”” &lt;function asyncio_run at 0x765d58031480&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/uvicorn/_compat.py&quot;, line 60, in asyncio_run
tvpl-api | 2025-10-28 16:48:30.345 |     return loop.run_until_complete(main)
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚    â”‚                  â”” &lt;coroutine object Server.serve at 0x765d57ef4740&gt;
tvpl-api | 2025-10-28 16:48:30.345 |            â”‚    â”” &lt;cyfunction Loop.run_until_complete at 0x765d57f2ea40&gt;
tvpl-api | 2025-10-28 16:48:30.345 |            â”” &lt;uvloop.Loop running=True closed=False debug=False&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/uvicorn/protocols/http/httptools_impl.py&quot;, line 409, in run_asgi
tvpl-api | 2025-10-28 16:48:30.345 |     result = await app(  # type: ignore[func-returns-value]
tvpl-api | 2025-10-28 16:48:30.345 |                    â”” &lt;uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x765d57e08ac0&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/uvicorn/middleware/proxy_headers.py&quot;, line 60, in __call__
tvpl-api | 2025-10-28 16:48:30.345 |     return await self.app(scope, receive, send)
tvpl-api | 2025-10-28 16:48:30.345 |                  â”‚    â”‚   â”‚      â”‚        â”” &lt;bound method RequestResponseCycle.send of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x765d535fe4...
tvpl-api | 2025-10-28 16:48:30.345 |                  â”‚    â”‚   â”‚      â”” &lt;bound method RequestResponseCycle.receive of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x765d535...
tvpl-api | 2025-10-28 16:48:30.345 |                  â”‚    â”‚   â”” {&#39;type&#39;: &#39;http&#39;, &#39;asgi&#39;: {&#39;version&#39;: &#39;3.0&#39;, &#39;spec_version&#39;: &#39;2.3&#39;}, &#39;http_version&#39;: &#39;1.1&#39;, &#39;server&#39;: (&#39;172.21.0.5&#39;, 8000), &#39;c...
tvpl-api | 2025-10-28 16:48:30.345 |                  â”‚    â”” &lt;fastapi.applications.FastAPI object at 0x765d57930040&gt;
tvpl-api | 2025-10-28 16:48:30.345 |                  â”” &lt;uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x765d57e08ac0&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/fastapi/applications.py&quot;, line 1134, in __call__
tvpl-api | 2025-10-28 16:48:30.345 |     await super().__call__(scope, receive, send)
tvpl-api | 2025-10-28 16:48:30.345 |                            â”‚      â”‚        â”” &lt;bound method RequestResponseCycle.send of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x765d535fe4...
tvpl-api | 2025-10-28 16:48:30.345 |                            â”‚      â”” &lt;bound method RequestResponseCycle.receive of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x765d535...
tvpl-api | 2025-10-28 16:48:30.345 |                            â”” {&#39;type&#39;: &#39;http&#39;, &#39;asgi&#39;: {&#39;version&#39;: &#39;3.0&#39;, &#39;spec_version&#39;: &#39;2.3&#39;}, &#39;http_version&#39;: &#39;1.1&#39;, &#39;server&#39;: (&#39;172.21.0.5&#39;, 8000), &#39;c...
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/starlette/applications.py&quot;, line 113, in __call__
tvpl-api | 2025-10-28 16:48:30.345 |     await self.middleware_stack(scope, receive, send)
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”‚                â”‚      â”‚        â”” &lt;bound method RequestResponseCycle.send of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x765d535fe4...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”‚                â”‚      â”” &lt;bound method RequestResponseCycle.receive of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x765d535...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”‚                â”” {&#39;type&#39;: &#39;http&#39;, &#39;asgi&#39;: {&#39;version&#39;: &#39;3.0&#39;, &#39;spec_version&#39;: &#39;2.3&#39;}, &#39;http_version&#39;: &#39;1.1&#39;, &#39;server&#39;: (&#39;172.21.0.5&#39;, 8000), &#39;c...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”” &lt;starlette.middleware.errors.ServerErrorMiddleware object at 0x765d535aef80&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”” &lt;fastapi.applications.FastAPI object at 0x765d57930040&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/starlette/middleware/errors.py&quot;, line 164, in __call__
tvpl-api | 2025-10-28 16:48:30.345 |     await self.app(scope, receive, _send)
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”‚   â”‚      â”‚        â”” &lt;function ServerErrorMiddleware.__call__.&lt;locals&gt;._send at 0x765d536023b0&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”‚   â”‚      â”” &lt;bound method RequestResponseCycle.receive of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x765d535...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”‚   â”” {&#39;type&#39;: &#39;http&#39;, &#39;asgi&#39;: {&#39;version&#39;: &#39;3.0&#39;, &#39;spec_version&#39;: &#39;2.3&#39;}, &#39;http_version&#39;: &#39;1.1&#39;, &#39;server&#39;: (&#39;172.21.0.5&#39;, 8000), &#39;c...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”” &lt;starlette.middleware.exceptions.ExceptionMiddleware object at 0x765d535ad810&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”” &lt;starlette.middleware.errors.ServerErrorMiddleware object at 0x765d535aef80&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/starlette/middleware/exceptions.py&quot;, line 63, in __call__
tvpl-api | 2025-10-28 16:48:30.345 |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚                            â”‚    â”‚    â”‚     â”‚      â”‚        â”” &lt;function ServerErrorMiddleware.__call__.&lt;locals&gt;._send at 0x765d536023b0&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚                            â”‚    â”‚    â”‚     â”‚      â”” &lt;bound method RequestResponseCycle.receive of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x765d535...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚                            â”‚    â”‚    â”‚     â”” {&#39;type&#39;: &#39;http&#39;, &#39;asgi&#39;: {&#39;version&#39;: &#39;3.0&#39;, &#39;spec_version&#39;: &#39;2.3&#39;}, &#39;http_version&#39;: &#39;1.1&#39;, &#39;server&#39;: (&#39;172.21.0.5&#39;, 8000), &#39;c...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚                            â”‚    â”‚    â”” &lt;starlette.requests.Request object at 0x765d535fe350&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚                            â”‚    â”” &lt;fastapi.middleware.asyncexitstack.AsyncExitStackMiddleware object at 0x765d535af160&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚                            â”” &lt;starlette.middleware.exceptions.ExceptionMiddleware object at 0x765d535ad810&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”” &lt;function wrap_app_handling_exceptions at 0x765d56b26b90&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/starlette/_exception_handler.py&quot;, line 42, in wrapped_app
tvpl-api | 2025-10-28 16:48:30.345 |     await app(scope, receive, sender)
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚   â”‚      â”‚        â”” &lt;function wrap_app_handling_exceptions.&lt;locals&gt;.wrapped_app.&lt;locals&gt;.sender at 0x765d53601120&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚   â”‚      â”” &lt;bound method RequestResponseCycle.receive of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x765d535...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚   â”” {&#39;type&#39;: &#39;http&#39;, &#39;asgi&#39;: {&#39;version&#39;: &#39;3.0&#39;, &#39;spec_version&#39;: &#39;2.3&#39;}, &#39;http_version&#39;: &#39;1.1&#39;, &#39;server&#39;: (&#39;172.21.0.5&#39;, 8000), &#39;c...
tvpl-api | 2025-10-28 16:48:30.345 |           â”” &lt;fastapi.middleware.asyncexitstack.AsyncExitStackMiddleware object at 0x765d535af160&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/fastapi/middleware/asyncexitstack.py&quot;, line 18, in __call__
tvpl-api | 2025-10-28 16:48:30.345 |     await self.app(scope, receive, send)
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”‚   â”‚      â”‚        â”” &lt;function wrap_app_handling_exceptions.&lt;locals&gt;.wrapped_app.&lt;locals&gt;.sender at 0x765d53601120&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”‚   â”‚      â”” &lt;bound method RequestResponseCycle.receive of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x765d535...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”‚   â”” {&#39;type&#39;: &#39;http&#39;, &#39;asgi&#39;: {&#39;version&#39;: &#39;3.0&#39;, &#39;spec_version&#39;: &#39;2.3&#39;}, &#39;http_version&#39;: &#39;1.1&#39;, &#39;server&#39;: (&#39;172.21.0.5&#39;, 8000), &#39;c...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”” &lt;fastapi.routing.APIRouter object at 0x765d535ad090&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”” &lt;fastapi.middleware.asyncexitstack.AsyncExitStackMiddleware object at 0x765d535af160&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/starlette/routing.py&quot;, line 716, in __call__
tvpl-api | 2025-10-28 16:48:30.345 |     await self.middleware_stack(scope, receive, send)
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”‚                â”‚      â”‚        â”” &lt;function wrap_app_handling_exceptions.&lt;locals&gt;.wrapped_app.&lt;locals&gt;.sender at 0x765d53601120&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”‚                â”‚      â”” &lt;bound method RequestResponseCycle.receive of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x765d535...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”‚                â”” {&#39;type&#39;: &#39;http&#39;, &#39;asgi&#39;: {&#39;version&#39;: &#39;3.0&#39;, &#39;spec_version&#39;: &#39;2.3&#39;}, &#39;http_version&#39;: &#39;1.1&#39;, &#39;server&#39;: (&#39;172.21.0.5&#39;, 8000), &#39;c...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”” &lt;bound method Router.app of &lt;fastapi.routing.APIRouter object at 0x765d535ad090&gt;&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”” &lt;fastapi.routing.APIRouter object at 0x765d535ad090&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/starlette/routing.py&quot;, line 736, in app
tvpl-api | 2025-10-28 16:48:30.345 |     await route.handle(scope, receive, send)
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚     â”‚      â”‚      â”‚        â”” &lt;function wrap_app_handling_exceptions.&lt;locals&gt;.wrapped_app.&lt;locals&gt;.sender at 0x765d53601120&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚     â”‚      â”‚      â”” &lt;bound method RequestResponseCycle.receive of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x765d535...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚     â”‚      â”” {&#39;type&#39;: &#39;http&#39;, &#39;asgi&#39;: {&#39;version&#39;: &#39;3.0&#39;, &#39;spec_version&#39;: &#39;2.3&#39;}, &#39;http_version&#39;: &#39;1.1&#39;, &#39;server&#39;: (&#39;172.21.0.5&#39;, 8000), &#39;c...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚     â”” &lt;function Route.handle at 0x765d56b48160&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”” APIRoute(path=&#39;/download-pending&#39;, name=&#39;download_pending&#39;, methods=[&#39;POST&#39;])
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/starlette/routing.py&quot;, line 290, in handle
tvpl-api | 2025-10-28 16:48:30.345 |     await self.app(scope, receive, send)
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”‚   â”‚      â”‚        â”” &lt;function wrap_app_handling_exceptions.&lt;locals&gt;.wrapped_app.&lt;locals&gt;.sender at 0x765d53601120&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”‚   â”‚      â”” &lt;bound method RequestResponseCycle.receive of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x765d535...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”‚   â”” {&#39;type&#39;: &#39;http&#39;, &#39;asgi&#39;: {&#39;version&#39;: &#39;3.0&#39;, &#39;spec_version&#39;: &#39;2.3&#39;}, &#39;http_version&#39;: &#39;1.1&#39;, &#39;server&#39;: (&#39;172.21.0.5&#39;, 8000), &#39;c...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚    â”” &lt;function request_response.&lt;locals&gt;.app at 0x765d53600790&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”” APIRoute(path=&#39;/download-pending&#39;, name=&#39;download_pending&#39;, methods=[&#39;POST&#39;])
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/fastapi/routing.py&quot;, line 124, in app
tvpl-api | 2025-10-28 16:48:30.345 |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚                            â”‚    â”‚        â”‚      â”‚        â”” &lt;function wrap_app_handling_exceptions.&lt;locals&gt;.wrapped_app.&lt;locals&gt;.sender at 0x765d53601120&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚                            â”‚    â”‚        â”‚      â”” &lt;bound method RequestResponseCycle.receive of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x765d535...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚                            â”‚    â”‚        â”” {&#39;type&#39;: &#39;http&#39;, &#39;asgi&#39;: {&#39;version&#39;: &#39;3.0&#39;, &#39;spec_version&#39;: &#39;2.3&#39;}, &#39;http_version&#39;: &#39;1.1&#39;, &#39;server&#39;: (&#39;172.21.0.5&#39;, 8000), &#39;c...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚                            â”‚    â”” &lt;starlette.requests.Request object at 0x765d535fe770&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚                            â”” &lt;function request_response.&lt;locals&gt;.app.&lt;locals&gt;.app at 0x765d53602200&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”” &lt;function wrap_app_handling_exceptions at 0x765d56b26b90&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/starlette/_exception_handler.py&quot;, line 42, in wrapped_app
tvpl-api | 2025-10-28 16:48:30.345 |     await app(scope, receive, sender)
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚   â”‚      â”‚        â”” &lt;function wrap_app_handling_exceptions.&lt;locals&gt;.wrapped_app.&lt;locals&gt;.sender at 0x765d536025f0&gt;
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚   â”‚      â”” &lt;bound method RequestResponseCycle.receive of &lt;uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x765d535...
tvpl-api | 2025-10-28 16:48:30.345 |           â”‚   â”” {&#39;type&#39;: &#39;http&#39;, &#39;asgi&#39;: {&#39;version&#39;: &#39;3.0&#39;, &#39;spec_version&#39;: &#39;2.3&#39;}, &#39;http_version&#39;: &#39;1.1&#39;, &#39;server&#39;: (&#39;172.21.0.5&#39;, 8000), &#39;c...
tvpl-api | 2025-10-28 16:48:30.345 |           â”” &lt;function request_response.&lt;locals&gt;.app.&lt;locals&gt;.app at 0x765d53602200&gt;
tvpl-api | 2025-10-28 16:48:30.345 |   File &quot;/usr/local/lib/python3.10/dist-packages/fastapi/routing.py&quot;, line 110, in app
tvpl-api | 2025-10-28 16:48:30.345 |     response = await f(request)
tvpl-api | 2025-10-28 16:48:30.345 |                      â”‚ â”” &lt;starlette.requests.Request object at 0x765d535fe770&gt;
tvpl-api | 2025-10-28 16:48:30.345 |                      â”” &lt;function get_request_handler.&lt;locals&gt;.app at 0x765d53600700&gt;
tvpl-api | 2025-10-28 16:48:30.346 |   File &quot;/usr/local/lib/python3.10/dist-packages/fastapi/routing.py&quot;, line 390, in app
tvpl-api | 2025-10-28 16:48:30.346 |     raw_response = await run_endpoint_function(
tvpl-api | 2025-10-28 16:48:30.346 |                          â”” &lt;function run_endpoint_function at 0x765d56b49d80&gt;
tvpl-api | 2025-10-28 16:48:30.346 |   File &quot;/usr/local/lib/python3.10/dist-packages/fastapi/routing.py&quot;, line 289, in run_endpoint_function
tvpl-api | 2025-10-28 16:48:30.346 |     return await dependant.call(**values)
tvpl-api | 2025-10-28 16:48:30.346 |                  â”‚         â”‚      â”” {&#39;limit&#39;: 1, &#39;file_types&#39;: [&#39;doc&#39;, &#39;docx&#39;]}
tvpl-api | 2025-10-28 16:48:30.346 |                  â”‚         â”” &lt;function download_pending at 0x765d53600430&gt;
tvpl-api | 2025-10-28 16:48:30.346 |                  â”” Dependant(path_params=[], query_params=[ModelField(field_info=Query(100), name=&#39;limit&#39;, mode=&#39;validation&#39;)], header_params=[]...
tvpl-api | 2025-10-28 16:48:30.346 | 
tvpl-api | 2025-10-28 16:48:30.346 | &gt; File &quot;/app/api/main.py&quot;, line 429, in download_pending
tvpl-api | 2025-10-28 16:48:30.346 |     file_id = file_info[&#39;file_id&#39;]
tvpl-api | 2025-10-28 16:48:30.346 |               â”” {&#39;id&#39;: 2, &#39;doc_id&#39;: &#39;678682&#39;, &#39;file_name&#39;: &#39;Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t&#39;, &#39;file_type&#39;: &#39;doc&#39;, &#39;file_url&#39;: &#39;https://thuvienphapluat...
tvpl-api | 2025-10-28 16:48:30.346 | 
tvpl-api | 2025-10-28 16:48:30.346 | KeyError: &#39;file_id&#39;

---

Báº£ng `document_files` dÃ¹ng `id` chá»© khÃ´ng pháº£i `file_id`. Fix:

---

ÄÃ£ fix. Cháº¡y láº¡i API.

---

ğŸŒ Starting FastAPI server...

INFO:     Started server process [1]

INFO:     Waiting for application startup.

INFO:     Application startup complete.

INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)

2025-10-28 09:49:09.374 | INFO     | api.main:download_pending:422 - Found 1 pending files to download

2025-10-28 09:49:09.444 | INFO     | api.main:download_pending:436 - Downloading Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t from https://thuvienphapluat.vn/documents/download.aspx?id=fWDMB%2fc6VdOISz47r1W8uQ%3d%3d&amp;part=-1

2025-10-28 09:49:09.744 | ERROR    | api.main:download_pending:463 - âœ— Failed to download Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t: Client error &#39;403 Forbidden&#39; for url &#39;https://thuvienphapluat.vn/documents/download.aspx?id=fWDMB%2fc6VdOISz47r1W8uQ%3d%3d&amp;part=-1&#39;

For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/403

---

403 Forbidden - cáº§n cookies/session Ä‘á»ƒ download. ThÃªm cookies vÃ o request:

---

ÄÃ£ thÃªm cookies tá»« `storage_state.json`. NhÆ°ng file nÃ y chá»‰ cÃ³ trÃªn local. TrÃªn Docker cáº§n login trÆ°á»›c hoáº·c dÃ¹ng cookies tá»« env. Táº¡m thá»i test xem cÃ³ work khÃ´ng.

---

âš ï¸ Database setup failed, continuing...

ğŸŒ Starting FastAPI server...

INFO:     Started server process [1]

INFO:     Waiting for application startup.

INFO:     Application startup complete.

INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)

2025-10-28 09:52:35.797 | INFO     | api.main:download_pending:422 - Found 1 pending files to download

2025-10-28 09:52:35.904 | INFO     | api.main:download_pending:445 - Downloading Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t from https://thuvienphapluat.vn/documents/download.aspx?id=fWDMB%2fc6VdOISz47r1W8uQ%3d%3d&amp;part=-1

2025-10-28 09:52:40.315 | ERROR    | api.main:download_pending:472 - âœ— Failed to download Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t: Client error &#39;403 Forbidden&#39; for url &#39;https://thuvienphapluat.vn/documents/download.aspx?id=fWDMB%2fc6VdOISz47r1W8uQ%3d%3d&amp;part=-1&#39;

For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/403

---

Váº«n 403 vÃ¬ khÃ´ng cÃ³ cookies. Cáº§n login trÆ°á»›c khi download. Táº¡o endpoint riÃªng hoáº·c dÃ¹ng Playwright Ä‘á»ƒ download (giá»‘ng tab8):

---

Cáº§n táº¡o script download riÃªng vá»›i Playwright (cÃ³ login session). Báº¡n muá»‘n tÃ´i táº¡o script `download_files.py` Ä‘á»ƒ download files vá»›i Playwright khÃ´ng?

---

tÃ´i cÃ³ api login riÃªng mÃ 

---

ÄÃºng, dÃ¹ng `/refresh-cookies` Ä‘á»ƒ login trÆ°á»›c, sau Ä‘Ã³ dÃ¹ng cookies Ä‘Ã³ Ä‘á»ƒ download. NhÆ°ng váº¥n Ä‘á» lÃ  cookies lÆ°u á»Ÿ `data/cookies.json` (local), khÃ´ng cÃ³ trÃªn Docker.

Giáº£i phÃ¡p: DÃ¹ng Playwright download trá»±c tiáº¿p (nhÆ° tab8) thay vÃ¬ httpx:

---

Create Playwright-based file downloader with login session support

---

File quÃ¡ dÃ i. Thay tháº¿ endpoint `/download-pending` báº±ng version má»›i dÃ¹ng Playwright. TÃ´i sáº½ táº¡o file má»›i cho API main ngáº¯n gá»n hÆ¡n hoáº·c báº¡n muá»‘n tÃ´i chá»‰ sá»­a pháº§n `/download-pending`?

---

nhÆ°ng táº¡i sao khi tÃ´i copy link lÃªn trÃ¬nh duyá»‡t thÃ¬ nÃ³ auto táº£i chá»© cÃ³ cáº§n Ä‘Äƒng nháº­p Ä‘Ã¢u

---

VÃ¬ browser cá»§a báº¡n Ä‘Ã£ cÃ³ cookies/session tá»« láº§n Ä‘Äƒng nháº­p trÆ°á»›c. NhÆ°ng httpx request khÃ´ng cÃ³ cookies nÃªn bá»‹ 403.

Thá»­ decode URL (cÃ³ `&amp;` thay vÃ¬ `&`):

---

ÄÃ£ fix decode `&amp;` â†’ `&`. Cháº¡y láº¡i xem cÃ³ work khÃ´ng.

---

ğŸŒ Starting FastAPI server...

INFO:     Started server process [1]

INFO:     Waiting for application startup.

INFO:     Application startup complete.

INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)

2025-10-28 09:57:47.629 | INFO     | api.main:download_pending:422 - Found 1 pending files to download

2025-10-28 09:57:47.688 | INFO     | api.main:download_pending:449 - Downloading Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t from https://thuvienphapluat.vn/documents/download.aspx?id=fWDMB%2fc6VdOISz47r1W8uQ%3d%3d&amp;part=-1

2025-10-28 09:57:52.590 | ERROR    | api.main:download_pending:476 - âœ— Failed to download Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t: Client error &#39;403 Forbidden&#39; for url &#39;https://thuvienphapluat.vn/documents/download.aspx?id=fWDMB%2fc6VdOISz47r1W8uQ%3d%3d&amp;part=-1&#39;

For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/403

---

Váº«n 403. Váº¥n Ä‘á» lÃ  khÃ´ng cÃ³ cookies. Gá»i `/refresh-cookies` trÆ°á»›c Ä‘á»ƒ táº¡o `storage_state.json`:

```bash
POST /refresh-cookies
```

Sau Ä‘Ã³ gá»i `/download-pending`. Hoáº·c thÃªm headers giá»‘ng browser:

---

ThÃªm User-Agent vÃ  Referer. Náº¿u váº«n 403 â†’ báº¯t buá»™c pháº£i cÃ³ cookies. Gá»i `/refresh-cookies` trÆ°á»›c hoáº·c dÃ¹ng Playwright download.

---

tháº¿ chá»‰ cáº§n login 1 láº§n xong , cá»© tháº¿ download Ã 

---

ÄÃºng! Login 1 láº§n â†’ lÆ°u cookies vÃ o `storage_state.json` â†’ dÃ¹ng cookies Ä‘Ã³ cho táº¥t cáº£ request download sau.

Workflow:
1. **Láº§n Ä‘áº§u**: `POST /refresh-cookies` â†’ táº¡o `data/storage_state.json`
2. **Sau Ä‘Ã³**: `POST /download-pending` â†’ dÃ¹ng cookies tá»« file Ä‘Ã³
3. **Khi háº¿t háº¡n** (vÃ i giá»/ngÃ y): gá»i láº¡i `/refresh-cookies`

NhÆ°ng trÃªn Docker file `data/storage_state.json` khÃ´ng tá»“n táº¡i. Cáº§n mount volume hoáº·c login má»—i láº§n restart. ThÃªm vÃ o docker-compose:

```yaml
volumes:
  - ./data:/app/data
```

Hoáº·c gá»i `/refresh-cookies` tá»± Ä‘á»™ng khi start API.

---

refresh-cookie Ä‘ang lÆ°u vÃ o data/cookies.json

---

ÄÃºng, nhÆ°ng code download Ä‘ang Ä‘á»c `storage_state.json`. Cáº§n Ä‘á»•i sang Ä‘á»c `cookies.json`:

---

ÄÃ£ Ä‘á»•i sang Ä‘á»c `data/cookies.json`. Gá»i `/refresh-cookies` trÆ°á»›c, sau Ä‘Ã³ `/download-pending` sáº½ dÃ¹ng cookies Ä‘Ã³.

---

ğŸ”§ Setting up database...

python: can&#39;t open file &#39;/app/setup_database.py&#39;: [Errno 2] No such file or directory

âš ï¸ Database setup failed, continuing...

ğŸŒ Starting FastAPI server...

INFO:     Started server process [1]

INFO:     Waiting for application startup.

INFO:     Application startup complete.

INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)

2025-10-28 10:03:22.584 | INFO     | api.main:download_pending:422 - Found 1 pending files to download

2025-10-28 10:03:22.686 | INFO     | api.main:download_pending:454 - Downloading Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t from https://thuvienphapluat.vn/documents/download.aspx?id=fWDMB%2fc6VdOISz47r1W8uQ%3d%3d&amp;part=-1

2025-10-28 10:04:36.777 | ERROR    | api.main:download_pending:481 - âœ— Failed to download Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t: {&#39;statusCode&#39;: 404, &#39;error&#39;: Bucket not found, &#39;message&#39;: Bucket not found}

---

Tiáº¿n bá»™! Download thÃ nh cÃ´ng nhÆ°ng bucket `tvpl-files` khÃ´ng tá»“n táº¡i trÃªn Supabase. Táº¡o bucket trÃªn Supabase Dashboard:

1. VÃ o **Storage** â†’ **New bucket**
2. TÃªn: `tvpl-files`
3. Public hoáº·c Private (tÃ¹y nhu cáº§u)
4. Create

Sau Ä‘Ã³ cháº¡y láº¡i `/download-pending`.

---

tÃ´i k Ä‘á»ƒ public bucket , cáº§n config gÃ¬ k

---

KhÃ´ng cáº§n config thÃªm. Private bucket + Service Role Key (Ä‘ang dÃ¹ng trong `SUPABASE_KEY`) Ä‘Ã£ Ä‘á»§ quyá»n upload/download.

Chá»‰ cáº§n táº¡o bucket `tvpl-files` vá»›i setting:
- **Public bucket**: OFF (private)
- **File size limit**: tÃ¹y chá»n (máº·c Ä‘á»‹nh OK)

Service role key cÃ³ full access nÃªn khÃ´ng cáº§n policy thÃªm. Cháº¡y láº¡i `/download-pending` sau khi táº¡o bucket.

---

tÃ´i Ä‘á»ƒ file env ngoÃ i tvpl_crawler, nÃ£y thay Ä‘á»•i thÃ¬ cÃ³ cáº§n rebuild láº¡i docker k

---

KhÃ´ng cáº§n rebuild. Chá»‰ cáº§n **restart**:

```bash
docker-compose restart tvpl-api
```

Hoáº·c náº¿u `.env` Ä‘Æ°á»£c mount vÃ o container:
```bash
docker-compose down
docker-compose up -d
```

Rebuild chá»‰ cáº§n khi thay Ä‘á»•i code Python hoáº·c `requirements.txt`.

---

python: can&#39;t open file &#39;/app/setup_database.py&#39;: [Errno 2] No such file or directory

âš ï¸ Database setup failed, continuing...

ğŸŒ Starting FastAPI server...

INFO:     Started server process [1]

INFO:     Waiting for application startup.

INFO:     Application startup complete.

INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)

2025-10-28 10:07:34.553 | INFO     | api.main:download_pending:422 - Found 1 pending files to download

2025-10-28 10:07:34.624 | INFO     | api.main:download_pending:454 - Downloading Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t from https://thuvienphapluat.vn/documents/download.aspx?id=fWDMB%2fc6VdOISz47r1W8uQ%3d%3d&amp;part=-1

2025-10-28 10:08:49.493 | ERROR    | api.main:download_pending:481 - âœ— Failed to download Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t: {&#39;statusCode&#39;: 404, &#39;error&#39;: Bucket not found, &#39;message&#39;: Bucket not found}
tÃ´i táº¡o bucket rá»“i mÃ  , nhÃ¬n áº£nh xem

---

Bucket Ä‘Ã£ táº¡o Ä‘Ãºng. Váº¥n Ä‘á» cÃ³ thá»ƒ do:

1. **Service role key khÃ´ng cÃ³ quyá»n** - Check láº¡i `SUPABASE_KEY` cÃ³ pháº£i service_role khÃ´ng (khÃ´ng pháº£i anon key)
2. **Bucket name sai** - Code Ä‘ang dÃ¹ng `os.getenv('SUPABASE_BUCKET', 'documents')` nhÆ°ng env lÃ  `tvpl-files`

Kiá»ƒm tra env Ä‘Ã£ load Ä‘Ãºng chÆ°a:

---

ÄÃ£ Ä‘á»•i default tá»« `documents` â†’ `tvpl-files` vÃ  thÃªm log. Restart vÃ  cháº¡y láº¡i Ä‘á»ƒ xem bucket name.

---

python: can&#39;t open file &#39;/app/setup_database.py&#39;: [Errno 2] No such file or directory

âš ï¸ Database setup failed, continuing...

ğŸŒ Starting FastAPI server...

INFO:     Started server process [1]

INFO:     Waiting for application startup.

INFO:     Application startup complete.

INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)

2025-10-28 10:11:01.632 | INFO     | api.main:download_pending:422 - Found 1 pending files to download

2025-10-28 10:11:01.698 | INFO     | api.main:download_pending:454 - Downloading Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t from https://thuvienphapluat.vn/documents/download.aspx?id=fWDMB%2fc6VdOISz47r1W8uQ%3d%3d&amp;part=-1

2025-10-28 10:11:21.993 | INFO     | api.main:download_pending:460 - Using bucket: tvpl-files

2025-10-28 10:12:20.935 | ERROR    | api.main:download_pending:482 - âœ— Failed to download Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t: {&#39;statusCode&#39;: 400, &#39;error&#39;: InvalidKey, &#39;message&#39;: Invalid key: 678682/Táº£i VÄƒn báº£n tiáº¿ng Viá»‡t}

---

Lá»—i `InvalidKey` - tÃªn file cÃ³ kÃ½ tá»± tiáº¿ng Viá»‡t khÃ´ng há»£p lá»‡. Cáº§n encode hoáº·c Ä‘á»•i tÃªn file:

---

ÄÃ£ Ä‘á»•i tÃªn file thÃ nh `{doc_id}.doc` thay vÃ¬ dÃ¹ng tÃªn tiáº¿ng Viá»‡t. Restart vÃ  cháº¡y láº¡i.

---

cÃ¡c file mÃ  cÃ³ download_status lÃ  failed thÃ¬ cÅ©ng cáº§n down láº¡i chá»© Ä‘Ãºng k , Ä‘Ã¢u pháº£i má»—i pending

---

ÄÃºng! Cáº§n download cáº£ `pending` vÃ  `failed`:

---

ÄÃ£ sá»­a query Ä‘á»ƒ láº¥y cáº£ `pending` vÃ  `failed`. Cháº¡y láº¡i sáº½ retry cÃ¡c file failed.

---

down file vá» lÆ°u á»Ÿ supabase thÃ¬ cÃ³ xem vá» khÃ´ng hay pháº£i down vá» local xem

---

LÆ°u trÃªn Supabase Storage cÃ³ thá»ƒ xem/download Ä‘Æ°á»£c:

**CÃ¡ch 1: Qua Dashboard**
- VÃ o Storage â†’ tvpl-files â†’ click file â†’ Download

**CÃ¡ch 2: Qua URL (náº¿u public)**
- `https://kbzprrfclidmligwzzom.supabase.co/storage/v1/object/public/tvpl-files/678682/678682.doc`

**CÃ¡ch 3: Qua API (private bucket)**
- DÃ¹ng service role key Ä‘á»ƒ táº¡o signed URL:
```python
url = supabase.storage.from_('tvpl-files').create_signed_url('678682/678682.doc', 3600)
```

KhÃ´ng cáº§n download vá» local Ä‘á»ƒ xem. NhÆ°ng náº¿u muá»‘n xem trá»±c tiáº¿p trÃªn web, cáº§n táº¡o signed URL hoáº·c set bucket public.

---

xem ná»™i dung trong file dc k , hay chá»‰ lÆ°u á»Ÿ db rá»“i khi nÃ o muá»‘n thÃ¬ táº£i vá» local

---

Supabase Storage chá»‰ **lÆ°u trá»¯ file**, khÃ´ng xem ná»™i dung trá»±c tiáº¿p (file .doc cáº§n Word/LibreOffice Ä‘á»ƒ má»Ÿ).

**Workflow:**
1. **LÆ°u trÃªn Supabase** - backup, tiáº¿t kiá»‡m local storage
2. **Khi cáº§n xem** - táº¡o signed URL â†’ download vá» â†’ má»Ÿ báº±ng Word

**Hoáº·c:**
- LÆ°u local luÃ´n (folder `data/downloads/`) - xem ngay khÃ´ng cáº§n download
- NhÆ°ng tá»‘n dung lÆ°á»£ng server

Báº¡n muá»‘n lÆ°u local hay chá»‰ Supabase?

---

Ä‘Æ°a tÃ´i schema db hiá»‡n táº¡i nÃ£y báº¡n táº¡o, Ä‘á»ƒ tÃ´i táº¡o lai db má»›i cho supabase sv cÃ´ng ty

---

File schema Ä‘Ã£ táº¡o á»Ÿ `current_schema.sql`:

---

ÄÃ¢y lÃ  file schema. NhÆ°ng cáº§n sá»­a `document_files` - Ä‘á»•i `file_id` thÃ nh `id` (nhÆ° Ä‘ang dÃ¹ng):

---

ÄÃ£ fix. Cháº¡y file `current_schema.sql` trÃªn Supabase server cÃ´ng ty Ä‘á»ƒ táº¡o láº¡i DB.

---

api link-basic dÃ¹ng playwright lÃ m gÃ¬ Ã­ nhá»‰ quÃªn r

---

`/links-basic` vá»›i `use_playwright=true` dÃ¹ng Ä‘á»ƒ:

**Crawl danh sÃ¡ch links tá»« trang search cÃ³ CAPTCHA**

- Bypass CAPTCHA trÃªn search page (nhÆ° Ä‘Ã£ lÃ m trong `links_playwright.py`)
- Láº¥y danh sÃ¡ch vÄƒn báº£n tá»« nhiá»u trang káº¿t quáº£ tÃ¬m kiáº¿m
- Tá»± Ä‘á»™ng upsert vÃ o báº£ng `doc_urls` vá»›i `status='pending'`

**VÃ­ dá»¥:**
```json
POST /links-basic
{
  "url": "https://thuvienphapluat.vn/tim-kiem.aspx?keyword=nghá»‹+Ä‘á»‹nh",
  "max_pages": 10,
  "use_playwright": true
}
```

â†’ Crawl 10 trang káº¿t quáº£ tÃ¬m kiáº¿m â†’ lÆ°u URLs vÃ o DB â†’ sau Ä‘Ã³ dÃ¹ng `/crawl-pending` Ä‘á»ƒ crawl chi tiáº¿t.

---

cÃ³ nÃªn bá» output ra khÃ´ng , táº¡i lÆ°u vÃ o db mÃ 

---

ÄÃºng, nÃªn bá» `output` vÃ¬ Ä‘Ã£ lÆ°u DB rá»“i. Hoáº·c giá»¯ láº¡i Ä‘á»ƒ backup JSON (phÃ²ng DB lá»—i). TÃ¹y báº¡n:

**Option 1: Bá» háº³n** - chá»‰ tráº£ vá» count
```json
{"status": "success", "inserted": 150, "updated": 20}
```

**Option 2: Giá»¯ nhÆ°ng optional** - máº·c Ä‘á»‹nh khÃ´ng tráº£ data, chá»‰ khi cáº§n
```json
POST /links-basic?return_data=false
```

TÃ´i nghÄ© **Option 1** tá»‘t hÆ¡n - bá» data trong response, chá»‰ tráº£ stats. Sá»­a khÃ´ng?

---

tvpl_crawler.links_playwright:crawl_links_with_playwright:47 - Crawling page 1: https://thuvienphapluat.vn/page/tim-van-ban.aspx?keyword=&amp;match=True&amp;area=0&amp;page=1

2025-10-28 10:26:34.157 | INFO     | tvpl_crawler.links_playwright:crawl_links_with_playwright:237 - Page 1: added 20 (unique: 20, raw: 20)

2025-10-28 10:26:34.157 | INFO     | tvpl_crawler.links_playwright:crawl_links_with_playwright:242 - Waiting 7.7s before next page...

2025-10-28 10:26:41.889 | INFO     | tvpl_crawler.links_playwright:crawl_links_with_playwright:47 - Crawling page 2: https://thuvienphapluat.vn/page/tim-van-ban.aspx?keyword=&amp;match=True&amp;area=0&amp;page=2

2025-10-28 10:26:45.932 | INFO     | tvpl_crawler.links_playwright:crawl_links_with_playwright:237 - Page 2: added 20 (unique: 20, raw: 20)

2025-10-28 10:26:45.933 | INFO     | tvpl_crawler.links_playwright:crawl_links_with_playwright:263 - Total crawled: 40 documents

2025-10-28 10:27:14.471 | INFO     | api.main:links_basic:171 - Upsert links: {&#39;inserted&#39;: 9, &#39;updated&#39;: 14, &#39;skipped&#39;: 17, &#39;total&#39;: 40}
sao tÃ´i k tháº¥y lÆ°u vÃ o db tÃ´i vá»«a set á»Ÿ env nhá»‰

---

Log hiá»‡n `Upsert links: inserted 9, updated 14` nghÄ©a lÃ  **Ä‘Ã£ lÆ°u vÃ o DB** rá»“i!

- **inserted: 9** - 9 URL má»›i thÃªm vÃ o
- **updated: 14** - 14 URL Ä‘Ã£ cÃ³, cáº­p nháº­t láº¡i
- **skipped: 17** - 17 URL khÃ´ng thay Ä‘á»•i

Kiá»ƒm tra trÃªn Supabase Dashboard â†’ Table Editor â†’ `doc_urls` â†’ sáº½ tháº¥y 40 records (9 má»›i + 31 cÅ©).

Náº¿u khÃ´ng tháº¥y â†’ check `SUPABASE_URL` trong env cÃ³ Ä‘Ãºng server cÃ´ng ty khÃ´ng?

---

cÃ³ cáº§n rebuild láº¡i Ä‘á»ƒ láº¥y env chuáº©n k hay restart

---

Chá»‰ cáº§n **restart**, khÃ´ng cáº§n rebuild:

```bash
docker-compose restart tvpl-api
```

Hoáº·c náº¿u thay Ä‘á»•i env trong `docker-compose.yml`:
```bash
docker-compose down
docker-compose up -d
```

Rebuild chá»‰ cáº§n khi thay Ä‘á»•i code Python hoáº·c `requirements.txt`.

---

táº¡i sao log lÃ  success nhÆ°ng mÃ  tÃ´i Ä‘á»•i 2 key trong env rá»“i mÃ , Ä‘Ã³ lÃ  supabase trÃªn server

---

@smithy/util-base64: toBase64 encoder function only accepts string | Uint8Array.

---

táº¡i sao log lÃ  success nhÆ°ng mÃ  tÃ´i Ä‘á»•i 2 key trong env rá»“i mÃ , Ä‘Ã³ lÃ  supabase trÃªn server

---

@smithy/util-base64: toBase64 encoder function only accepts string | Uint8Array.

---

123

---

@smithy/util-base64: toBase64 encoder function only accepts string | Uint8Array.

---

&quot;Ä‘Ã¢sda&quot;

---

@smithy/util-base64: toBase64 encoder function only accepts string | Uint8Array.